<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Instrumentation Guide — HiveBoard Docs</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
<style>
/* ═══════════════════════════════════════
   DESIGN TOKENS (HiveBoard system)
   ═══════════════════════════════════════ */
:root {
    --accent: #c2410c;
    --accent-dim: rgba(194, 65, 12, 0.06);
    --accent-hover: #a93b0b;
    --accent-light: rgba(194, 65, 12, 0.1);
    --font-mono: 'IBM Plex Mono', monospace;
    --font-sans: 'Plus Jakarta Sans', sans-serif;
    --radius-sm: 6px;
    --radius-md: 10px;
    --bg-deep: #f5f3ef;
    --bg-primary: #ffffff;
    --bg-card: #ffffff;
    --bg-elevated: #fafaf8;
    --bg-hover: #f0eeea;
    --border: #e2e0db;
    --border-subtle: #eceae5;
    --text-primary: #1a1a1a;
    --text-secondary: #4a4a4a;
    --text-muted: #8a8a8a;
    --success: #16a34a;
    --success-dim: rgba(22, 163, 74, 0.08);
    --error: #dc2626;
    --error-dim: rgba(220, 38, 38, 0.06);
    --warning: #d97706;
    --warning-dim: rgba(217, 119, 6, 0.08);
    --info: #2563eb;
    --info-dim: rgba(37, 99, 235, 0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: var(--font-sans);
    background: var(--bg-deep);
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
}

@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes fade-in-up { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

/* ═══════════════════════════════════════
   TOP BAR
   ═══════════════════════════════════════ */
.topbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; height: 56px;
    background: var(--bg-primary); border-bottom: 1px solid var(--border);
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
}
.topbar-left { display: flex; align-items: center; gap: 20px; }
.logo {
    display: flex; align-items: center; gap: 10px;
    font-family: var(--font-sans); font-weight: 800; font-size: 17px;
    letter-spacing: -0.5px; text-decoration: none; color: var(--text-primary);
}
.logo-hex {
    width: 28px; height: 28px; background: var(--accent);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.logo-hex-inner {
    width: 18px; height: 18px; background: var(--bg-primary);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
}
.logo span { color: var(--accent); }

.docs-badge {
    font-family: var(--font-mono); font-size: 11px; font-weight: 600;
    color: var(--accent); background: var(--accent-dim);
    padding: 3px 10px; border-radius: 4px;
    text-transform: uppercase; letter-spacing: 0.5px;
    border: 1px solid rgba(194, 65, 12, 0.12);
}

.topbar-right { display: flex; align-items: center; gap: 12px; }
.topbar-link {
    font-family: var(--font-sans); font-size: 13px; font-weight: 600;
    color: var(--text-secondary); text-decoration: none;
    padding: 7px 14px; border-radius: var(--radius-sm);
    transition: all 0.15s; border: 1px solid transparent;
}
.topbar-link:hover { background: var(--bg-hover); color: var(--text-primary); }
.topbar-link.primary {
    color: #fff; background: var(--accent); border-color: var(--accent);
}
.topbar-link.primary:hover { background: var(--accent-hover); }

/* ═══════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════ */
.docs-layout {
    display: flex; min-height: 100vh; padding-top: 56px;
}

/* ─── LEFT SIDEBAR ─── */
.docs-sidebar {
    width: 260px; flex-shrink: 0;
    background: var(--bg-primary);
    border-right: 1px solid var(--border);
    padding: 20px 12px;
    position: fixed; top: 56px; bottom: 0; left: 0;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
}
.docs-sidebar::-webkit-scrollbar { width: 4px; }
.docs-sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.docs-nav-section {
    font-family: var(--font-sans); font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--text-muted); padding: 16px 12px 6px;
}
.docs-nav-section:first-child { padding-top: 0; }

.docs-nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 12px; border-radius: var(--radius-sm);
    font-family: var(--font-sans); font-size: 13.5px; font-weight: 500;
    color: var(--text-secondary); text-decoration: none;
    transition: all 0.12s; border: 1px solid transparent;
}
.docs-nav-item:hover {
    background: var(--bg-hover); color: var(--text-primary);
}
.docs-nav-item.active {
    background: var(--accent-dim); color: var(--accent);
    font-weight: 600; border-color: rgba(194, 65, 12, 0.1);
}
.docs-nav-icon {
    width: 18px; height: 18px; flex-shrink: 0; opacity: 0.5;
    display: flex; align-items: center;
}
.docs-nav-icon svg { width: 18px; height: 18px; }
.docs-nav-item.active .docs-nav-icon { opacity: 1; color: var(--accent); }

/* ─── MAIN CONTENT ─── */
.docs-main {
    flex: 1; margin-left: 260px; margin-right: 220px;
    padding: 40px 48px 80px;
    max-width: 820px;
    animation: fade-in 0.3s ease;
}

/* ─── RIGHT TOC ─── */
.page-toc {
    position: fixed; top: 96px; right: 24px;
    width: 196px; max-height: calc(100vh - 120px);
    overflow-y: auto; scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
}
.page-toc::-webkit-scrollbar { width: 3px; }
.page-toc::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.page-toc-title {
    font-family: var(--font-sans); font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--text-muted); padding-bottom: 8px;
    border-bottom: 1px solid var(--border-subtle);
    margin-bottom: 8px;
}
.toc-link {
    display: block; padding: 4px 0;
    font-family: var(--font-sans); font-size: 12.5px; font-weight: 500;
    color: var(--text-muted); text-decoration: none;
    transition: color 0.15s;
    line-height: 1.4;
    border-left: 2px solid transparent;
    padding-left: 10px;
    margin-left: -1px;
}
.toc-link:hover { color: var(--text-primary); }
.toc-link.toc-h3 { padding-left: 22px; font-size: 12px; }
.toc-link.active {
    color: var(--accent); font-weight: 600;
    border-left-color: var(--accent);
}

/* ═══════════════════════════════════════
   CONTENT TYPOGRAPHY
   ═══════════════════════════════════════ */
.doc-content h1 {
    font-family: var(--font-sans); font-size: 28px; font-weight: 800;
    letter-spacing: -0.7px; line-height: 1.2;
    margin-bottom: 8px; color: var(--text-primary);
}
.doc-content h2 {
    font-family: var(--font-sans); font-size: 21px; font-weight: 700;
    letter-spacing: -0.3px; line-height: 1.3;
    margin-top: 48px; margin-bottom: 16px;
    padding-top: 24px; border-top: 1px solid var(--border-subtle);
    color: var(--text-primary);
}
.doc-content h2:first-of-type { margin-top: 32px; border-top: none; padding-top: 0; }

.doc-content h3 {
    font-family: var(--font-sans); font-size: 17px; font-weight: 700;
    margin-top: 32px; margin-bottom: 12px;
    color: var(--text-primary);
}
.doc-content h4 {
    font-family: var(--font-sans); font-size: 15px; font-weight: 700;
    margin-top: 24px; margin-bottom: 8px;
    color: var(--text-secondary);
}

.heading-anchor {
    color: var(--accent); text-decoration: none;
    opacity: 0; font-weight: 400; margin-left: 6px;
    transition: opacity 0.15s;
}
h2:hover .heading-anchor,
h3:hover .heading-anchor,
h4:hover .heading-anchor { opacity: 0.5; }
.heading-anchor:hover { opacity: 1 !important; }

.doc-content p {
    font-size: 15px; line-height: 1.7;
    color: var(--text-secondary); margin-bottom: 16px;
}
.doc-content strong { color: var(--text-primary); font-weight: 600; }

.doc-content a {
    color: var(--accent); text-decoration: none;
    border-bottom: 1px solid rgba(194, 65, 12, 0.2);
    transition: border-color 0.15s;
}
.doc-content a:hover { border-bottom-color: var(--accent); }

.doc-content ul, .doc-content ol {
    margin-bottom: 16px; padding-left: 24px;
}
.doc-content li {
    font-size: 15px; line-height: 1.7;
    color: var(--text-secondary); margin-bottom: 6px;
}
.doc-content li strong { color: var(--text-primary); }

/* Inline code */
.doc-content code {
    font-family: var(--font-mono); font-size: 13px; font-weight: 500;
    color: var(--accent); background: var(--accent-dim);
    padding: 2px 6px; border-radius: 4px;
    border: 1px solid rgba(194, 65, 12, 0.08);
}

/* Code blocks */
.code-block {
    position: relative; margin-bottom: 20px;
    background: #1e1e2e; border-radius: var(--radius-md);
    border: 1px solid #2a2a3e;
    overflow: hidden;
}
.code-block .code-lang {
    position: absolute; top: 0; right: 0;
    font-family: var(--font-mono); font-size: 10px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    color: #8888aa; background: rgba(255,255,255,0.05);
    padding: 4px 12px; border-radius: 0 var(--radius-md) 0 6px;
}
.code-block pre {
    margin: 0; padding: 20px 24px; overflow-x: auto;
    scrollbar-width: thin; scrollbar-color: #444 transparent;
}
.code-block pre::-webkit-scrollbar { height: 4px; }
.code-block pre::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
.code-block pre code {
    font-family: var(--font-mono); font-size: 13px; line-height: 1.6;
    color: #cdd6f4; background: none; padding: 0; border: none; border-radius: 0;
}

/* Tables */
.table-wrapper {
    margin-bottom: 20px; overflow-x: auto;
    border: 1px solid var(--border); border-radius: var(--radius-md);
    scrollbar-width: thin;
}
.table-wrapper table {
    width: 100%; border-collapse: collapse;
    font-size: 14px;
}
.table-wrapper th {
    font-family: var(--font-sans); font-size: 12px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.4px;
    color: var(--text-muted); background: var(--bg-elevated);
    text-align: left; padding: 10px 16px;
    border-bottom: 1px solid var(--border);
}
.table-wrapper td {
    font-family: var(--font-sans); font-size: 14px; line-height: 1.5;
    color: var(--text-secondary); padding: 10px 16px;
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: top;
}
.table-wrapper tr:last-child td { border-bottom: none; }
.table-wrapper tr:hover td { background: var(--bg-elevated); }
.table-wrapper td code {
    font-size: 12px;
}

/* Blockquotes / Callouts */
.callout {
    margin-bottom: 20px; padding: 16px 20px;
    border-left: 3px solid var(--border);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    background: var(--bg-elevated);
}
.callout p { margin-bottom: 8px; font-size: 14px; }
.callout p:last-child { margin-bottom: 0; }
.callout em { color: var(--text-muted); }

.callout-warning {
    border-left-color: var(--warning);
    background: var(--warning-dim);
}
.callout-tip {
    border-left-color: var(--success);
    background: var(--success-dim);
}
.callout-info {
    border-left-color: var(--info);
    background: var(--info-dim);
}
.callout-danger {
    border-left-color: var(--error);
    background: var(--error-dim);
}

/* HR */
.doc-content hr {
    border: none; height: 1px;
    background: var(--border); margin: 32px 0;
}

/* ─── VERSION BADGE ─── */
.doc-meta {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 24px;
}
.doc-meta-badge {
    font-family: var(--font-mono); font-size: 11px; font-weight: 600;
    color: var(--text-muted); background: var(--bg-elevated);
    padding: 3px 10px; border-radius: 4px;
    border: 1px solid var(--border-subtle);
}

/* ─── PREV / NEXT NAV ─── */
.prev-next {
    display: flex; gap: 16px; margin-top: 48px;
    padding-top: 24px; border-top: 1px solid var(--border);
}
.prev-next-link {
    flex: 1; display: block; padding: 16px 20px;
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: var(--radius-md); text-decoration: none;
    transition: all 0.15s;
}
.prev-next-link:hover {
    border-color: var(--accent); background: var(--accent-dim);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(194, 65, 12, 0.06);
}
.prev-next-link.next { text-align: right; }
.prev-next-label {
    font-family: var(--font-sans); font-size: 12px; font-weight: 600;
    color: var(--text-muted); display: block; margin-bottom: 4px;
}
.prev-next-title {
    font-family: var(--font-sans); font-size: 15px; font-weight: 700;
    color: var(--text-primary);
}
.prev-next-link:hover .prev-next-title { color: var(--accent); }

/* ─── MOBILE MENU ─── */
.mobile-menu-toggle {
    display: none; align-items: center; justify-content: center;
    width: 36px; height: 36px; border: 1px solid var(--border);
    border-radius: var(--radius-sm); background: var(--bg-primary);
    cursor: pointer; color: var(--text-secondary);
}

/* ═══════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════ */
@media (max-width: 1200px) {
    .page-toc { display: none; }
    .docs-main { margin-right: 0; }
}

@media (max-width: 860px) {
    .mobile-menu-toggle { display: flex; }
    .docs-sidebar {
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        z-index: 50;
        box-shadow: none;
    }
    .docs-sidebar.open {
        transform: translateX(0);
        box-shadow: 8px 0 30px rgba(0,0,0,0.1);
    }
    .docs-main {
        margin-left: 0; padding: 28px 20px 60px;
    }
    .doc-content h1 { font-size: 24px; }
    .doc-content h2 { font-size: 19px; }
    .prev-next { flex-direction: column; }
}

/* ═══════════════════════════════════════
   PRISM THEME OVERRIDES (dark code blocks)
   ═══════════════════════════════════════ */
.code-block .token.comment,
.code-block .token.prolog,
.code-block .token.doctype { color: #6c7086; }
.code-block .token.punctuation { color: #a6adc8; }
.code-block .token.property,
.code-block .token.tag,
.code-block .token.boolean,
.code-block .token.number { color: #fab387; }
.code-block .token.string,
.code-block .token.attr-value { color: #a6e3a1; }
.code-block .token.selector,
.code-block .token.attr-name,
.code-block .token.builtin { color: #89b4fa; }
.code-block .token.keyword { color: #cba6f7; }
.code-block .token.function { color: #89b4fa; }
.code-block .token.operator { color: #89dceb; }
.code-block .token.class-name { color: #f9e2af; }
.code-block .token.decorator { color: #f38ba8; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div class="topbar-left">
        <a href="home.html" class="logo">
            <div class="logo-hex"><div class="logo-hex-inner"></div></div>
            Hive<span>Board</span>
        </a>
        <span class="docs-badge">Docs</span>
    </div>
    <div class="topbar-right">
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle navigation">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M3 5h12M3 9h12M3 13h12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
        </button>
        <a href="https://github.com/hiveboard/hiveloop" class="topbar-link" target="_blank" rel="noopener">GitHub</a>
        <a href="home.html" class="topbar-link primary">Open Dashboard</a>
    </div>
</div>

<!-- LAYOUT -->
<div class="docs-layout">
    <!-- SIDEBAR -->
    <nav class="docs-sidebar" id="docsSidebar">
<div class="docs-nav-section">Getting Started</div>
<a class="docs-nav-item" href="user-manual.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><path d="M2 3.5A1.5 1.5 0 013.5 2H7a2 2 0 012 2v12.5l-.5-.5-3-3H3.5A1.5 1.5 0 012 11.5v-8z" stroke="currentColor" stroke-width="1.3"/><path d="M16 3.5A1.5 1.5 0 0014.5 2H11a2 2 0 00-2 2v12.5l.5-.5 3-3h2A1.5 1.5 0 0016 11.5v-8z" stroke="currentColor" stroke-width="1.3"/></svg></span><span>SDK Manual</span></a>
<a class="docs-nav-item" href="integration-guide.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><path d="M6 2v4M12 2v4M4 6h10v3a5 5 0 01-5 5 5 5 0 01-5-5V6zM9 14v3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span>Integration Guide</span></a>
<div class="docs-nav-section">Dashboard</div>
<a class="docs-nav-item" href="docs-dashboard-guide.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><rect x="2" y="2" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.3"/><path d="M2 7h14M7 7v9" stroke="currentColor" stroke-width="1.3"/></svg></span><span>Dashboard Guide</span></a>
<div class="docs-nav-section">Instrumentation</div>
<a class="docs-nav-item active" href="docs-instrumentation-guide.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="1.3"/><circle cx="9" cy="9" r="4" stroke="currentColor" stroke-width="1.3"/><circle cx="9" cy="9" r="1" fill="currentColor"/></svg></span><span>Instrumentation</span></a>
<a class="docs-nav-item" href="docs-layer1-guide.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><path d="M9 2L2 6l7 4 7-4-7-4zM2 12l7 4 7-4M2 9l7 4 7-4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span>Layer 1 Guide</span></a>
<div class="docs-nav-section">Rich Events</div>
<a class="docs-nav-item" href="docs-layer2-rich-events.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><path d="M10 2L3 10h5l-1 6 7-8h-5l1-6z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span>Rich Events</span></a>
<a class="docs-nav-item" href="docs-layer2-llm-tracking.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><rect x="4" y="4" width="10" height="10" rx="1.5" stroke="currentColor" stroke-width="1.3"/><rect x="7" y="7" width="4" height="4" rx="0.5" stroke="currentColor" stroke-width="1.3"/><path d="M7 2v2M11 2v2M7 14v2M11 14v2M2 7h2M2 11h2M14 7h2M14 11h2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg></span><span>LLM Tracking</span></a>
<a class="docs-nav-item" href="docs-operational-events.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><path d="M16 9h-3l-2 7L7 2 5 9H2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span>Operational Events</span></a>
<a class="docs-nav-item" href="docs-track-context.html"><span class="docs-nav-icon"><svg viewBox="0 0 18 18" fill="none"><circle cx="5" cy="5" r="2" stroke="currentColor" stroke-width="1.3"/><circle cx="13" cy="5" r="2" stroke="currentColor" stroke-width="1.3"/><circle cx="5" cy="13" r="2" stroke="currentColor" stroke-width="1.3"/><path d="M5 7v4M13 7c0 3-2 4-8 4" stroke="currentColor" stroke-width="1.3"/></svg></span><span>Track Context</span></a>

    </nav>

    <!-- MAIN CONTENT -->
    <main class="docs-main">
        <div class="doc-meta">
            <span class="doc-meta-badge">v0.1.0</span>
            <span class="doc-meta-badge">Updated Feb 2026</span>
        </div>
        <article class="doc-content">
<h1 id="hiveboard-user-manual-part-3-instrumentation-guide">HiveBoard — User Manual Part 3: Instrumentation Guide <a class="heading-anchor" href="#hiveboard-user-manual-part-3-instrumentation-guide" aria-label="Link to this section">#</a></h1>
<p><strong>Version:</strong> 0.1.0
<strong>Last updated:</strong> 2026-02-12</p>
<blockquote class="callout"><p><em>How to find WHERE to instrument and HOW to add HiveLoop to any agent codebase.</em></p></blockquote>
<hr />
<h2 id="table-of-contents">Table of Contents <a class="heading-anchor" href="#table-of-contents" aria-label="Link to this section">#</a></h2>
<ol>
<li><a href="#1-the-instrumentation-mindset">The Instrumentation Mindset</a></li>
<li><a href="#2-layer-0-recap--init--heartbeat">Layer 0 Recap — Init + Heartbeat</a></li>
<li><a href="#3-finding-where-to-add-agenttask">Finding WHERE to Add agent.task()</a></li>
<li><a href="#4-finding-where-to-add-agenttrack">Finding WHERE to Add agent.track()</a></li>
<li><a href="#5-plumbing--getting-the-task-object-where-you-need-it">Plumbing — Getting the Task Object Where You Need It</a></li>
<li><a href="#6-implementation-patterns-for-classes-and-methods">Implementation Patterns for Classes and Methods</a></li>
<li><a href="#7-validating-your-instrumentation">Validating Your Instrumentation</a></li>
<li><a href="#8-adding-layer-2--rich-events">Adding Layer 2 — Rich Events</a></li>
<li><a href="#9-architecture-specific-guidance">Architecture-Specific Guidance</a></li>
<li><a href="#10-the-safety-contract">The Safety Contract</a></li>
<li><a href="#11-incremental-instrumentation-checklist">Incremental Instrumentation Checklist</a></li>
<li><a href="#12-common-mistakes">Common Mistakes</a></li>
</ol>
<hr />
<h2 id="1-the-instrumentation-mindset">1. The Instrumentation Mindset <a class="heading-anchor" href="#1-the-instrumentation-mindset" aria-label="Link to this section">#</a></h2>
<p>Instrumenting an existing codebase is not about adding code everywhere. It's about answering three questions precisely, then making surgical additions.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Question</th>
  <th>What it finds</th>
  <th>HiveLoop feature</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>&quot;Where does a unit of work start and end?&quot;</strong></td>
  <td>The task boundary</td>
  <td><code>agent.task()</code></td>
</tr>
<tr>
  <td><strong>&quot;What are the meaningful steps inside that work?&quot;</strong></td>
  <td>The tracked actions</td>
  <td><code>@agent.track()</code></td>
</tr>
<tr>
  <td><strong>&quot;How does data flow through the call stack?&quot;</strong></td>
  <td>The plumbing pattern</td>
  <td><code>contextvars</code>, parameter passing, or context objects</td>
</tr>
</tbody>
</table></div>
<p>Answer these three questions for your codebase and you have your instrumentation plan. Everything else is syntax.</p>
<h3 id="the-golden-rule">The golden rule <a class="heading-anchor" href="#the-golden-rule" aria-label="Link to this section">#</a></h3>
<p><strong>Instrument from the outside in.</strong> Start at the highest level (task boundary), then go one level deeper (actions), then add richness (LLM calls, plans, escalations). At every level, verify on the dashboard before going deeper. If a layer doesn't work, you'll know exactly where the problem is.</p>
<hr />
<h2 id="2-layer-0-recap-init-heartbeat">2. Layer 0 Recap — Init + Heartbeat <a class="heading-anchor" href="#2-layer-0-recap-init-heartbeat" aria-label="Link to this section">#</a></h2>
<p>Before starting Layer 1, make sure Layer 0 is working:</p>
<ul>
<li>[ ] <code>hiveloop.init()</code> is called at application startup</li>
<li>[ ] <code>hb.agent()</code> is called for each agent</li>
<li>[ ] Agents appear in The Hive on the dashboard</li>
<li>[ ] Heartbeat dots are green</li>
<li>[ ] <code>agent_registered</code> events appear in the Activity Stream</li>
</ul>
<p>If any of these are missing, fix Layer 0 first. See Part 1 (Sections 4 and 11) for troubleshooting.</p>
<hr />
<h2 id="3-finding-where-to-add-agenttask">3. Finding WHERE to Add <code>agent.task()</code> <a class="heading-anchor" href="#3-finding-where-to-add-agenttask" aria-label="Link to this section">#</a></h2>
<h3 id="31-what-is-a-quottaskquot">3.1 What is a &quot;task&quot;? <a class="heading-anchor" href="#31-what-is-a-quottaskquot" aria-label="Link to this section">#</a></h3>
<p>A task is the answer to: <strong>&quot;If someone asked what your agent is doing right now, what would you say?&quot;</strong></p>
<p>Good examples of tasks:</p>
<ul>
<li>&quot;Processing lead #4801&quot;</li>
<li>&quot;Triaging support ticket #1002&quot;</li>
<li>&quot;Running ETL batch for 2026-02-12&quot;</li>
<li>&quot;Generating quarterly report&quot;</li>
<li>&quot;Responding to user query abc123&quot;</li>
</ul>
<p>A task has a clear beginning, a clear end, and a result (success or failure).</p>
<h3 id="32-how-to-find-the-task-boundary">3.2 How to find the task boundary <a class="heading-anchor" href="#32-how-to-find-the-task-boundary" aria-label="Link to this section">#</a></h3>
<p>Look for code that matches one of these patterns:</p>
<p><strong>Pattern A — Loop processing items:</strong></p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">while True:
    item = queue.get()        # ← task starts here
    result = process(item)    #    work happens
    save(result)              # ← task ends here
</code></pre></div>
<p><strong>Pattern B — Request handler:</strong></p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">@app.post(&quot;/process&quot;)
async def handle(request):    # ← task starts here
    result = do_work(request) #    work happens
    return result             # ← task ends here
</code></pre></div>
<p><strong>Pattern C — Callback / event handler:</strong></p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">def on_event(event):          # ← task starts here
    result = handle(event)    #    work happens
    emit_result(result)       # ← task ends here
</code></pre></div>
<p><strong>Pattern D — Scheduled job:</strong></p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">@scheduler.every(&quot;1h&quot;)
def hourly_job():             # ← task starts here
    data = fetch()            #    work happens
    process(data)             # ← task ends here
</code></pre></div>
<h3 id="33-the-decision-checklist">3.3 The decision checklist <a class="heading-anchor" href="#33-the-decision-checklist" aria-label="Link to this section">#</a></h3>
<p>When evaluating a code location, ask:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Question</th>
  <th>If yes →</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Does this code represent one complete job from start to finish?</td>
  <td>This is your task boundary</td>
</tr>
<tr>
  <td>Could I give this a meaningful task ID? (e.g. &quot;process-lead-4801&quot;)</td>
  <td>Good task boundary</td>
</tr>
<tr>
  <td>Does this code call multiple sub-functions that each do something distinct?</td>
  <td>This is a task, and those sub-functions are tracked actions</td>
</tr>
<tr>
  <td>Is this code called repeatedly (once per item, once per request)?</td>
  <td>Each call is one task</td>
</tr>
<tr>
  <td>Is this code called once at startup and runs forever?</td>
  <td>This is NOT a task — look one level deeper for the per-item work</td>
</tr>
</tbody>
</table></div>
<h3 id="34-common-traps">3.4 Common traps <a class="heading-anchor" href="#34-common-traps" aria-label="Link to this section">#</a></h3>
<p><strong>Too high:</strong> Wrapping <code>main()</code> as a single task. A task should represent one unit of work, not the entire process lifetime.</p>
<p><strong>Too low:</strong> Wrapping individual LLM calls as tasks. LLM calls happen inside tasks — they're events, not tasks.</p>
<p><strong>Too many:</strong> Wrapping every function as a task. If you have 50 tasks per user request, your task granularity is too fine. Each task should be something meaningful at the business level.</p>
<h3 id="35-adding-agenttask">3.5 Adding <code>agent.task()</code> <a class="heading-anchor" href="#35-adding-agenttask" aria-label="Link to this section">#</a></h3>
<p>Once you've found the boundary:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># BEFORE:
def process_item(item):
    result = step_one(item)
    result = step_two(result)
    return result

# AFTER:
def process_item(item):
    hiveloop_agent = get_hiveloop_agent()
    if hiveloop_agent:
        with hiveloop_agent.task(
            item.id,                    # unique task ID
            project=&quot;my-project&quot;,       # project context
            type=&quot;item_processing&quot;,     # task classification
        ) as task:
            set_current_task(task)      # make accessible deeper in the stack
            try:
                result = step_one(item)
                result = step_two(result)
                return result
            finally:
                set_current_task(None)
    else:
        result = step_one(item)
        result = step_two(result)
        return result
</code></pre></div>
<p><strong>Choosing a task ID:</strong> The ID should be unique per execution and human-readable. Good patterns:</p>
<ul>
<li><code>f&quot;process-lead-{lead.id}&quot;</code> — includes the entity ID</li>
<li><code>f&quot;task-{uuid.uuid4().hex[:8]}&quot;</code> — unique but anonymous</li>
<li><code>event.id</code> — if your system already has event/job IDs</li>
</ul>
<p><strong>Choosing a project:</strong> Projects group related work. If all your agents serve one purpose, one project is fine. If agents serve different domains (sales, support, operations), use different projects.</p>
<hr />
<h2 id="4-finding-where-to-add-agenttrack">4. Finding WHERE to Add <code>@agent.track()</code> <a class="heading-anchor" href="#4-finding-where-to-add-agenttrack" aria-label="Link to this section">#</a></h2>
<h3 id="41-what-is-a-quottracked-actionquot">4.1 What is a &quot;tracked action&quot;? <a class="heading-anchor" href="#41-what-is-a-quottracked-actionquot" aria-label="Link to this section">#</a></h3>
<p>A tracked action is a function that represents a <strong>meaningful step</strong> in a task's execution. When you're debugging a failed task and reading the timeline, these are the steps you want to see.</p>
<h3 id="42-the-selection-criteria">4.2 The selection criteria <a class="heading-anchor" href="#42-the-selection-criteria" aria-label="Link to this section">#</a></h3>
<p><strong>Good candidates for tracking:</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Criterion</th>
  <th>Example</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Calls an external service</td>
  <td><code>fetch_from_crm()</code>, <code>call_llm()</code>, <code>send_email()</code></td>
</tr>
<tr>
  <td>Makes a decision</td>
  <td><code>route_ticket()</code>, <code>classify_intent()</code>, <code>score_lead()</code></td>
</tr>
<tr>
  <td>Transforms data meaningfully</td>
  <td><code>enrich_lead()</code>, <code>parse_document()</code>, <code>generate_report()</code></td>
</tr>
<tr>
  <td>Takes significant time (&gt;100ms)</td>
  <td>API calls, LLM calls, database queries</td>
</tr>
<tr>
  <td>Has a name a human would understand</td>
  <td><code>evaluate_lead</code>, <code>send_notification</code>, <code>create_plan</code></td>
</tr>
<tr>
  <td>Could fail independently</td>
  <td>Anything that can throw an exception worth knowing about</td>
</tr>
</tbody>
</table></div>
<p><strong>Bad candidates for tracking:</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Criterion</th>
  <th>Example</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Internal utilities</td>
  <td><code>format_date()</code>, <code>validate_email()</code>, <code>build_prompt()</code></td>
</tr>
<tr>
  <td>Runs in microseconds</td>
  <td>Getters, setters, string formatting</td>
</tr>
<tr>
  <td>Called hundreds of times per task</td>
  <td>Loop iterations, per-item validators</td>
</tr>
<tr>
  <td>Has no external side effect</td>
  <td>Pure computation, in-memory transformations</td>
</tr>
<tr>
  <td>Would clutter the timeline</td>
  <td>If you'd have 50+ nodes for one task, you're tracking too much</td>
</tr>
</tbody>
</table></div>
<h3 id="43-the-quot5-7-nodesquot-rule">4.3 The &quot;5-7 nodes&quot; rule <a class="heading-anchor" href="#43-the-quot5-7-nodesquot-rule" aria-label="Link to this section">#</a></h3>
<p>A good task timeline has roughly <strong>5 to 7 major action nodes</strong>. This is enough to tell the story of what happened without overwhelming the viewer. If you're tracking more than 10-15 functions per task, you're probably tracking too deep.</p>
<p>Example of a well-balanced timeline:</p>
<div class="code-block"><pre><code>[task_started] → [fetch_data] → [llm_reasoning] → [score_lead] → [route_lead] → [task_completed]
</code></pre></div>
<p>Example of an over-instrumented timeline:</p>
<div class="code-block"><pre><code>[task_started] → [validate_input] → [format_request] → [build_headers] → [open_connection] → 
[send_request] → [parse_json] → [extract_fields] → [validate_response] → [build_prompt] → 
[count_tokens] → [call_api] → [parse_response] → [extract_score] → [validate_score] → ...
</code></pre></div>
<h3 id="44-finding-candidates-in-your-codebase">4.4 Finding candidates in your codebase <a class="heading-anchor" href="#44-finding-candidates-in-your-codebase" aria-label="Link to this section">#</a></h3>
<p>Ask Claude (or search manually) with this framework:</p>
<p><em>&quot;In [your codebase], trace the execution path from [task entry point] to completion. List every function that:</em></p>
<ol>
<li><em>Calls an external service (API, LLM, database)</em></li>
<li><em>Makes a routing or classification decision</em></li>
<li><em>Could fail independently</em></li>
<li><em>Takes more than 100ms</em></li>
</ol>
<p><em>For each, give the function name, file, and a one-line description of what it does.&quot;</em></p>
<p>Then pick the top 5-7 as your initial tracked actions.</p>
<h3 id="45-adding-tracking">4.5 Adding tracking <a class="heading-anchor" href="#45-adding-tracking" aria-label="Link to this section">#</a></h3>
<p>For standalone functions:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">@agent.track(&quot;fetch_crm_data&quot;)
def fetch_crm_data(lead_id):
    return crm_client.get(lead_id)
</code></pre></div>
<p>For class methods, see Section 6 for patterns.</p>
<hr />
<h2 id="5-plumbing-getting-the-task-object-where-you-need-it">5. Plumbing — Getting the Task Object Where You Need It <a class="heading-anchor" href="#5-plumbing-getting-the-task-object-where-you-need-it" aria-label="Link to this section">#</a></h2>
<p>This is the most common integration challenge. The <code>agent.task()</code> context manager is created at the top level (where work starts), but <code>task.llm_call()</code>, <code>task.event()</code>, and other calls need to happen deeper in the call stack.</p>
<h3 id="51-assess-your-call-depth">5.1 Assess your call depth <a class="heading-anchor" href="#51-assess-your-call-depth" aria-label="Link to this section">#</a></h3>
<p>How deep is the call stack between your task boundary and the functions that need the task object?</p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Depth</th>
  <th>Description</th>
  <th>Recommended pattern</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>Shallow (1-2 levels)</strong></td>
  <td>Task entry point directly calls the functions</td>
  <td>Pass <code>task</code> as a parameter</td>
</tr>
<tr>
  <td><strong>Medium (3-5 levels)</strong></td>
  <td>Several function calls between entry and usage</td>
  <td><code>contextvars</code> (recommended)</td>
</tr>
<tr>
  <td><strong>Deep (6+ levels)</strong></td>
  <td>Many layers of abstraction, frameworks, middleware</td>
  <td><code>contextvars</code> or framework context object</td>
</tr>
<tr>
  <td><strong>Cross-thread</strong></td>
  <td>Work dispatched to other threads</td>
  <td><code>contextvars</code> (automatic with <code>asyncio</code>; for threads, copy context manually)</td>
</tr>
</tbody>
</table></div>
<h3 id="52-pattern-a-pass-as-parameter-shallow-stacks">5.2 Pattern A — Pass as parameter (shallow stacks) <a class="heading-anchor" href="#52-pattern-a-pass-as-parameter-shallow-stacks" aria-label="Link to this section">#</a></h3>
<p>The simplest approach. Just add <code>task=None</code> to function signatures:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">with agent.task(task_id) as task:
    result = process(item, task=task)

def process(item, task=None):
    score = score_item(item, task=task)
    if task:
        task.event(&quot;scored&quot;, {&quot;score&quot;: score})
    return score

def score_item(item, task=None):
    response = llm.call(prompt)
    if task:
        task.llm_call(&quot;scoring&quot;, model=&quot;...&quot;, tokens_in=N, tokens_out=N)
    return response.score
</code></pre></div>
<p><strong>Pros:</strong> Explicit, easy to understand, no magic.
<strong>Cons:</strong> Requires changing function signatures. Gets tedious with deep stacks.</p>
<h3 id="53-pattern-b-contextvars-medium-to-deep-stacks">5.3 Pattern B — <code>contextvars</code> (medium to deep stacks) <a class="heading-anchor" href="#53-pattern-b-contextvars-medium-to-deep-stacks" aria-label="Link to this section">#</a></h3>
<p>Create a single module that manages the current task context:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># observability.py (new file in your project)
import contextvars

_current_task = contextvars.ContextVar('hiveloop_task', default=None)

def set_current_task(task):
    &quot;&quot;&quot;Call this when entering a task context.&quot;&quot;&quot;
    _current_task.set(task)

def get_current_task():
    &quot;&quot;&quot;Call this anywhere to get the current task (or None).&quot;&quot;&quot;
    return _current_task.get()

def clear_current_task():
    &quot;&quot;&quot;Call this when exiting a task context.&quot;&quot;&quot;
    _current_task.set(None)
</code></pre></div>
<p>At the task boundary:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">from myproject.observability import set_current_task, clear_current_task

with agent.task(task_id) as task:
    set_current_task(task)
    try:
        result = process(item)  # no task parameter needed
    finally:
        clear_current_task()
</code></pre></div>
<p>Anywhere deeper in the code:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">from myproject.observability import get_current_task

def deep_function():
    # No function signature changes needed
    task = get_current_task()
    if task:
        task.llm_call(&quot;reasoning&quot;, model=&quot;...&quot;, tokens_in=N, tokens_out=N)
</code></pre></div>
<p><strong>Pros:</strong> No function signature changes. Works across any call depth. Thread-safe. Async-safe.
<strong>Cons:</strong> Implicit (the task isn't visible in function signatures). Requires a shared module.</p>
<p><strong>Why <code>contextvars</code> is recommended:</strong> Python's <code>contextvars</code> module was designed exactly for this use case — propagating request-scoped data through a call stack without passing it explicitly. It's what frameworks like FastAPI, Django, and asyncio use internally. Each thread and each async task gets its own context automatically.</p>
<h3 id="54-pattern-c-framework-context-object-web-frameworks">5.4 Pattern C — Framework context object (web frameworks) <a class="heading-anchor" href="#54-pattern-c-framework-context-object-web-frameworks" aria-label="Link to this section">#</a></h3>
<p>If your agent runs inside a web framework, attach the task to the request object:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># FastAPI example
@app.post(&quot;/process&quot;)
async def handle(request: Request):
    with agent.task(task_id) as task:
        request.state.hiveloop_task = task
        return await process(request)

# Deeper in the code
async def process(request: Request):
    task = getattr(request.state, 'hiveloop_task', None)
    if task:
        task.llm_call(...)
</code></pre></div>
<p><strong>Pros:</strong> Natural for web frameworks. No extra modules needed.
<strong>Cons:</strong> Only works when a request object is available throughout the stack.</p>
<h3 id="55-combining-patterns">5.5 Combining patterns <a class="heading-anchor" href="#55-combining-patterns" aria-label="Link to this section">#</a></h3>
<p>You can mix patterns. Use <code>contextvars</code> for the general case, and pass <code>task</code> explicitly where it makes the code clearer:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">with agent.task(task_id) as task:
    set_current_task(task)
    try:
        # Deep calls use contextvars
        result = complex_pipeline(item)
        
        # Direct calls can pass explicitly for clarity
        send_notification(result, task=task)
    finally:
        clear_current_task()
</code></pre></div>
<hr />
<h2 id="6-implementation-patterns-for-classes-and-methods">6. Implementation Patterns for Classes and Methods <a class="heading-anchor" href="#6-implementation-patterns-for-classes-and-methods" aria-label="Link to this section">#</a></h2>
<p>Most production agents use classes. Decorating class methods requires extra consideration because the <code>agent</code> handle isn't available at class definition time.</p>
<h3 id="61-the-challenge">6.1 The challenge <a class="heading-anchor" href="#61-the-challenge" aria-label="Link to this section">#</a></h3>
<p>This doesn't work:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">class MyProcessor:
    @agent.track(&quot;process&quot;)   # ❌ agent doesn't exist when class is defined
    def process(self, item):
        ...
</code></pre></div>
<h3 id="62-pattern-a-context-manager-inside-the-method">6.2 Pattern A — Context manager inside the method <a class="heading-anchor" href="#62-pattern-a-context-manager-inside-the-method" aria-label="Link to this section">#</a></h3>
<p>Wrap the method body instead of decorating:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">class MyProcessor:
    def process(self, item):
        hiveloop_agent = get_hiveloop_agent(self.agent_name)
        if hiveloop_agent:
            with hiveloop_agent.track_context(&quot;process&quot;):
                return self._process_inner(item)
        return self._process_inner(item)

    def _process_inner(self, item):
        # original logic, unchanged
        ...
</code></pre></div>
<p><strong>Pros:</strong> Clean separation. Original logic untouched.
<strong>Cons:</strong> Two functions instead of one. Some duplication in the routing.</p>
<h3 id="63-pattern-b-helper-function-to-reduce-boilerplate">6.3 Pattern B — Helper function to reduce boilerplate <a class="heading-anchor" href="#63-pattern-b-helper-function-to-reduce-boilerplate" aria-label="Link to this section">#</a></h3>
<p>Create a helper that handles the conditional wrapping:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># observability.py
def tracked(action_name, agent_name=None):
    &quot;&quot;&quot;Wrap a function call with HiveLoop tracking if available.&quot;&quot;&quot;
    def decorator(func):
        def wrapper(*args, **kwargs):
            hiveloop_agent = get_hiveloop_agent(agent_name)
            if hiveloop_agent:
                with hiveloop_agent.track_context(action_name):
                    return func(*args, **kwargs)
            return func(*args, **kwargs)
        return wrapper
    return decorator
</code></pre></div>
<p>Usage:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">class MyProcessor:
    @tracked(&quot;process&quot;, agent_name=&quot;my-agent&quot;)
    def process(self, item):
        # original logic, unchanged
        ...
</code></pre></div>
<p><strong>Pros:</strong> Clean decorator syntax. Original logic untouched.
<strong>Cons:</strong> Agent name must be known at decoration time (or resolved dynamically).</p>
<h3 id="64-pattern-c-dynamic-decorator-at-runtime">6.4 Pattern C — Dynamic decorator at runtime <a class="heading-anchor" href="#64-pattern-c-dynamic-decorator-at-runtime" aria-label="Link to this section">#</a></h3>
<p>Apply the decorator when the agent handle becomes available:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">class MyProcessor:
    def setup_tracking(self, hiveloop_agent):
        &quot;&quot;&quot;Call this after the hiveloop agent is created.&quot;&quot;&quot;
        self.process = hiveloop_agent.track(&quot;process&quot;)(self.process)
        self.score = hiveloop_agent.track(&quot;score&quot;)(self.score)

    def process(self, item):
        ...

    def score(self, item):
        ...
</code></pre></div>
<p>Call during initialization:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">processor = MyProcessor()
hiveloop_agent = hb.agent(&quot;my-agent&quot;)
processor.setup_tracking(hiveloop_agent)
</code></pre></div>
<p><strong>Pros:</strong> Uses the native decorator API. Clean.
<strong>Cons:</strong> Requires an explicit setup step. Must be called after agent creation.</p>
<h3 id="65-pattern-d-use-task-events-instead-of-decorators">6.5 Pattern D — Use task events instead of decorators <a class="heading-anchor" href="#65-pattern-d-use-task-events-instead-of-decorators" aria-label="Link to this section">#</a></h3>
<p>Skip decorators entirely. Use the task object from <code>contextvars</code> and emit custom events:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">class MyProcessor:
    def process(self, item):
        task = get_current_task()
        if task:
            task.event(&quot;action_started&quot;, {&quot;action&quot;: &quot;process&quot;, &quot;item_id&quot;: item.id})

        result = self._do_work(item)

        if task:
            task.event(&quot;action_completed&quot;, {&quot;action&quot;: &quot;process&quot;, &quot;result&quot;: result.status})

        return result
</code></pre></div>
<p><strong>Pros:</strong> No decorator complexity. Full control over what's emitted.
<strong>Cons:</strong> More verbose. Doesn't get automatic duration tracking or exception capture.</p>
<h3 id="66-which-pattern-should-i-use">6.6 Which pattern should I use? <a class="heading-anchor" href="#66-which-pattern-should-i-use" aria-label="Link to this section">#</a></h3>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Situation</th>
  <th>Recommended pattern</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Standalone functions (not in a class)</td>
  <td>Standard <code>@agent.track()</code> decorator</td>
</tr>
<tr>
  <td>Class methods where agent name is fixed</td>
  <td>Pattern B (helper decorator)</td>
</tr>
<tr>
  <td>Class methods where agent is created dynamically</td>
  <td>Pattern C (runtime decorator) or Pattern A (context manager)</td>
</tr>
<tr>
  <td>Legacy code you don't want to modify</td>
  <td>Pattern D (task events from contextvars)</td>
</tr>
<tr>
  <td>Prototype / quick instrumentation</td>
  <td>Pattern A (context manager)</td>
</tr>
</tbody>
</table></div>
<hr />
<h2 id="7-validating-your-instrumentation">7. Validating Your Instrumentation <a class="heading-anchor" href="#7-validating-your-instrumentation" aria-label="Link to this section">#</a></h2>
<p>After adding <code>agent.task()</code> and <code>@agent.track()</code>, validate each step on the dashboard before going deeper.</p>
<h3 id="71-validation-checklist-agenttask">7.1 Validation checklist — <code>agent.task()</code> <a class="heading-anchor" href="#71-validation-checklist-agenttask" aria-label="Link to this section">#</a></h3>
<p>Trigger a task in your agent, then check:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Dashboard element</th>
  <th>What you should see</th>
  <th>If missing</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>Task Table</strong></td>
  <td>A new row with your task ID, agent name, type, and status</td>
  <td><code>agent.task()</code> isn't being called — check that the code path is reached</td>
</tr>
<tr>
  <td><strong>Task status</strong></td>
  <td><code>processing</code> while running, <code>completed</code> or <code>failed</code> after</td>
  <td>If stuck on <code>processing</code>, the context manager isn't exiting cleanly</td>
</tr>
<tr>
  <td><strong>Activity Stream</strong></td>
  <td><code>task_started</code> event, then <code>task_completed</code> or <code>task_failed</code></td>
  <td>Check stream filter — make sure &quot;task&quot; or &quot;all&quot; is selected</td>
</tr>
<tr>
  <td><strong>Stats Ribbon</strong></td>
  <td>Processing count goes to 1 during execution, then back to 0</td>
  <td>Verify the agent card shows PROCESSING during execution</td>
</tr>
<tr>
  <td><strong>Agent card</strong></td>
  <td>Shows PROCESSING badge and <code>↳ task_id</code> during execution</td>
  <td>If still IDLE, the task isn't linked to the correct agent</td>
</tr>
</tbody>
</table></div>
<h3 id="72-validation-checklist-agenttrack">7.2 Validation checklist — <code>@agent.track()</code> <a class="heading-anchor" href="#72-validation-checklist-agenttrack" aria-label="Link to this section">#</a></h3>
<p>With tracking active, trigger a task and check:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Dashboard element</th>
  <th>What you should see</th>
  <th>If missing</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>Timeline</strong></td>
  <td>Nodes for each tracked function, connected with duration lines</td>
  <td>Functions aren't being decorated, or the decorator isn't from the right agent handle</td>
</tr>
<tr>
  <td><strong>Activity Stream</strong></td>
  <td><code>action_started</code> and <code>action_completed</code> events for each tracked function</td>
  <td>Check that the decorator is applied correctly (not shadowed or overridden)</td>
</tr>
<tr>
  <td><strong>Timeline node details</strong></td>
  <td>Click a node → shows function name, duration, and any error info</td>
  <td>Working correctly</td>
</tr>
<tr>
  <td><strong>Nested actions</strong></td>
  <td>If function A calls function B (both tracked), B appears as a child of A in the timeline</td>
  <td>Verify both are decorated and called within the same task context</td>
</tr>
</tbody>
</table></div>
<h3 id="73-validation-checklist-error-handling">7.3 Validation checklist — Error handling <a class="heading-anchor" href="#73-validation-checklist-error-handling" aria-label="Link to this section">#</a></h3>
<p>Deliberately trigger a failure to verify error tracking:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Scenario</th>
  <th>Expected on dashboard</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Exception inside a task</td>
  <td>Task status → <code>failed</code>, red node in timeline, <code>task_failed</code> in Activity Stream</td>
</tr>
<tr>
  <td>Exception inside a tracked function</td>
  <td><code>action_failed</code> event, red node, but task may continue if exception is caught</td>
</tr>
<tr>
  <td>Agent crashes (kill the process)</td>
  <td>Agent heartbeat stops, card goes STUCK after threshold</td>
</tr>
</tbody>
</table></div>
<h3 id="74-quick-smoke-test-sequence">7.4 Quick smoke test sequence <a class="heading-anchor" href="#74-quick-smoke-test-sequence" aria-label="Link to this section">#</a></h3>
<ol>
<li>Start HiveBoard server</li>
<li>Start your agent</li>
<li>Verify agent appears in The Hive (Layer 0)</li>
<li>Trigger one task</li>
<li>Verify task appears in Task Table</li>
<li>Click the task row — verify Timeline shows nodes</li>
<li>Verify Activity Stream shows task + action events</li>
<li>Trigger a failure — verify red nodes and <code>failed</code> status</li>
<li>✅ Layer 1 is working</li>
</ol>
<hr />
<h2 id="8-adding-layer-2-rich-events">8. Adding Layer 2 — Rich Events <a class="heading-anchor" href="#8-adding-layer-2-rich-events" aria-label="Link to this section">#</a></h2>
<p>Once Layer 1 is validated, add rich events for the data that tells the full story.</p>
<h3 id="81-priority-order">8.1 Priority order <a class="heading-anchor" href="#81-priority-order" aria-label="Link to this section">#</a></h3>
<p>Add Layer 2 events in this order (highest value first):</p>
<div class="table-wrapper"><table>
<thead>
<tr>
  <th>Priority</th>
  <th>Event</th>
  <th>Why it's valuable</th>
  <th>Dashboard location</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>1</strong></td>
  <td><code>task.llm_call()</code></td>
  <td>Cost visibility — the #1 feature request</td>
  <td>Cost Explorer + Timeline</td>
</tr>
<tr>
  <td><strong>2</strong></td>
  <td><code>task.escalate()</code></td>
  <td>Know when agents need human help</td>
  <td>Activity Stream + Timeline</td>
</tr>
<tr>
  <td><strong>3</strong></td>
  <td><code>task.plan()</code> + <code>task.plan_step()</code></td>
  <td>See progress and where plans fail</td>
  <td>Plan progress bar in Timeline</td>
</tr>
<tr>
  <td><strong>4</strong></td>
  <td><code>agent.report_issue()</code></td>
  <td>Agent self-reported problems</td>
  <td>Pipeline tab in Agent Detail</td>
</tr>
<tr>
  <td><strong>5</strong></td>
  <td><code>task.request_approval()</code> + <code>task.approval_received()</code></td>
  <td>Human-in-the-loop tracking</td>
  <td>Activity Stream + agent status</td>
</tr>
<tr>
  <td><strong>6</strong></td>
  <td><code>task.retry()</code></td>
  <td>Retry patterns and failure recovery</td>
  <td>Timeline branching</td>
</tr>
<tr>
  <td><strong>7</strong></td>
  <td><code>agent.todo()</code> + <code>agent.scheduled()</code></td>
  <td>Work pipeline visibility</td>
  <td>Pipeline tab in Agent Detail</td>
</tr>
</tbody>
</table></div>
<h3 id="82-finding-where-to-add-llm-calls">8.2 Finding WHERE to add LLM calls <a class="heading-anchor" href="#82-finding-where-to-add-llm-calls" aria-label="Link to this section">#</a></h3>
<p>Search your codebase for LLM client calls. Common patterns:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># OpenAI-style
response = client.chat.completions.create(model=..., messages=...)

# Anthropic-style
response = client.messages.create(model=..., messages=...)

# Generic wrapper
response = llm.complete(prompt=..., model=...)
response = llm_client.call(model=..., prompt=...)
</code></pre></div>
<p>After each call, add:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">task = get_current_task()
if task:
    task.llm_call(
        &quot;descriptive_name&quot;,           # what this call does
        model=model_name,
        tokens_in=response.usage.input_tokens,
        tokens_out=response.usage.output_tokens,
        cost=calculated_cost,         # see Part 1, Section 6.1 for cost calculation
        duration_ms=elapsed_ms,
    )
</code></pre></div>
<h3 id="83-finding-where-to-add-escalations-and-approvals">8.3 Finding WHERE to add escalations and approvals <a class="heading-anchor" href="#83-finding-where-to-add-escalations-and-approvals" aria-label="Link to this section">#</a></h3>
<p>Search for patterns where your agent:</p>
<ul>
<li>Stops and waits for human input</li>
<li>Delegates to another agent or team</li>
<li>Flags something for review</li>
<li>Enters a &quot;pending&quot; state</li>
</ul>
<p>These map to <code>task.escalate()</code>, <code>task.request_approval()</code>, and <code>task.approval_received()</code>.</p>
<h3 id="84-finding-where-to-add-plans">8.4 Finding WHERE to add plans <a class="heading-anchor" href="#84-finding-where-to-add-plans" aria-label="Link to this section">#</a></h3>
<p>If your agent creates execution plans (step-by-step strategies), add <code>task.plan()</code> at plan creation and <code>task.plan_step()</code> as each step progresses. Look for:</p>
<ul>
<li>Plan/strategy objects being created</li>
<li>Step arrays or phase lists</li>
<li>Progress tracking through sequential stages</li>
</ul>
<hr />
<h2 id="9-architecture-specific-guidance">9. Architecture-Specific Guidance <a class="heading-anchor" href="#9-architecture-specific-guidance" aria-label="Link to this section">#</a></h2>
<h3 id="91-single-loop-agent">9.1 Single loop agent <a class="heading-anchor" href="#91-single-loop-agent" aria-label="Link to this section">#</a></h3>
<div class="code-block"><pre><code>Entry point: main() → while True loop
Task boundary: Each iteration of the loop
Actions: Functions called within each iteration
Plumbing: contextvars (set at loop top, cleared at bottom)
</code></pre></div>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">hb = hiveloop.init(api_key=&quot;...&quot;)
agent = hb.agent(&quot;my-agent&quot;)

while True:
    item = queue.get()
    with agent.task(item.id, project=&quot;my-project&quot;) as task:
        set_current_task(task)
        try:
            process(item)
        finally:
            clear_current_task()
</code></pre></div>
<h3 id="92-multi-agent-system">9.2 Multi-agent system <a class="heading-anchor" href="#92-multi-agent-system" aria-label="Link to this section">#</a></h3>
<div class="code-block"><pre><code>Entry point: Application startup (creates agents dynamically)
Task boundary: Per-agent per-job execution
Actions: Agent-specific processing functions
Plumbing: Agent registry + contextvars
</code></pre></div>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">hb = hiveloop.init(api_key=&quot;...&quot;)
_agents = {}

def create_agent(name, agent_type):
    _agents[name] = hb.agent(name, type=agent_type)

def run_agent_task(agent_name, job):
    hiveloop_agent = _agents.get(agent_name)
    if hiveloop_agent:
        with hiveloop_agent.task(job.id, project=&quot;my-project&quot;) as task:
            set_current_task(task)
            try:
                execute(job)
            finally:
                clear_current_task()
    else:
        execute(job)
</code></pre></div>
<h3 id="93-api-driven-agent-fastapi">9.3 API-driven agent (FastAPI) <a class="heading-anchor" href="#93-api-driven-agent-fastapi" aria-label="Link to this section">#</a></h3>
<div class="code-block"><pre><code>Entry point: Application startup (lifespan or on_event)
Task boundary: Each HTTP request
Actions: Service functions called by the handler
Plumbing: Request state or contextvars
</code></pre></div>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">hb = hiveloop.init(api_key=&quot;...&quot;)
agent = hb.agent(&quot;api-agent&quot;)

@app.post(&quot;/process&quot;)
async def handle(request: ProcessRequest):
    with agent.task(request.id, project=&quot;api-service&quot;) as task:
        set_current_task(task)
        try:
            result = await process(request)
            return result
        finally:
            clear_current_task()
</code></pre></div>
<h3 id="94-framework-based-langchain-crewai">9.4 Framework-based (LangChain, CrewAI) <a class="heading-anchor" href="#94-framework-based-langchain-crewai" aria-label="Link to this section">#</a></h3>
<div class="code-block"><pre><code>Entry point: Application startup
Task boundary: Handled by the framework callback (each agent.invoke() or crew.kickoff())
Actions: Mapped automatically by the callback
Plumbing: Framework handles it internally
</code></pre></div>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">from hiveloop.integrations.langchain import LangChainCallback

hb = hiveloop.init(api_key=&quot;...&quot;)
callback = LangChainCallback(hb, project=&quot;my-project&quot;)
agent.invoke({&quot;input&quot;: &quot;...&quot;}, config={&quot;callbacks&quot;: [callback]})
</code></pre></div>
<blockquote class="callout callout-info"><p><strong>Note:</strong> Framework integrations handle task creation, action tracking, and LLM call logging automatically through the framework's callback system. No manual <code>agent.task()</code> or <code>@agent.track()</code> needed.</p></blockquote>
<h3 id="95-scheduled-cron-based-agent">9.5 Scheduled / cron-based agent <a class="heading-anchor" href="#95-scheduled-cron-based-agent" aria-label="Link to this section">#</a></h3>
<div class="code-block"><pre><code>Entry point: Scheduler setup
Task boundary: Each scheduled execution
Actions: Steps within the scheduled job
Plumbing: contextvars (set at job start)
</code></pre></div>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python">hb = hiveloop.init(api_key=&quot;...&quot;)
agent = hb.agent(&quot;scheduler-agent&quot;)

@scheduler.every(&quot;1h&quot;)
def hourly_sync():
    task_id = f&quot;sync-{datetime.now().strftime('%Y%m%d-%H%M')}&quot;
    with agent.task(task_id, project=&quot;data-ops&quot;, type=&quot;sync&quot;) as task:
        set_current_task(task)
        try:
            fetch_data()
            transform_data()
            load_data()
        finally:
            clear_current_task()
</code></pre></div>
<hr />
<h2 id="10-the-safety-contract">10. The Safety Contract <a class="heading-anchor" href="#10-the-safety-contract" aria-label="Link to this section">#</a></h2>
<p>HiveLoop follows a strict safety contract: <strong>your agent must never break because of observability.</strong></p>
<h3 id="101-rules">10.1 Rules <a class="heading-anchor" href="#101-rules" aria-label="Link to this section">#</a></h3>
<ol>
<li><p><strong>HiveLoop never raises transport errors.</strong> Network failures, server downtime, 500 errors — all caught and logged silently. Your code never sees them.</p>
</li>
<li><p><strong>HiveLoop never swallows your exceptions.</strong> If your code raises, the exception propagates normally. HiveLoop records it and re-raises.</p>
</li>
<li><p><strong>HiveLoop never blocks your code.</strong> All network I/O happens in a background thread. <code>task.llm_call()</code>, <code>task.event()</code>, etc. are queue-append operations that return immediately.</p>
</li>
<li><p><strong>HiveLoop is always optional.</strong> Every instrumentation point should have a graceful fallback:</p>
</li>
</ol>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># This pattern should be everywhere:
task = get_current_task()
if task:
    task.llm_call(...)
# If task is None, nothing happens. Your agent runs normally.
</code></pre></div>
<h3 id="102-testing-without-hiveboard">10.2 Testing without HiveBoard <a class="heading-anchor" href="#102-testing-without-hiveboard" aria-label="Link to this section">#</a></h3>
<p>You can run your agent without the HiveBoard server running. HiveLoop will buffer events, fail to send them, and silently discard them after retries. Your agent runs identically.</p>
<p>To disable HiveLoop entirely in tests:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># Don't call hiveloop.init() in your test configuration.
# All get_current_task() calls return None.
# All if task: guards skip.
# Zero overhead.
</code></pre></div>
<h3 id="103-the-if-task-guard">10.3 The <code>if task:</code> guard <a class="heading-anchor" href="#103-the-if-task-guard" aria-label="Link to this section">#</a></h3>
<p>Every place you call a task method, guard it:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># ✅ Safe:
task = get_current_task()
if task:
    task.llm_call(&quot;reasoning&quot;, model=model_name, tokens_in=N, tokens_out=N)

# ❌ Unsafe (will crash if task is None):
get_current_task().llm_call(&quot;reasoning&quot;, model=model_name, tokens_in=N, tokens_out=N)
</code></pre></div>
<p>This one-line guard is the price of safety. It's worth it.</p>
<hr />
<h2 id="11-incremental-instrumentation-checklist">11. Incremental Instrumentation Checklist <a class="heading-anchor" href="#11-incremental-instrumentation-checklist" aria-label="Link to this section">#</a></h2>
<p>Use this checklist to track your progress. Each step is independently valuable.</p>
<h3 id="layer-0-init-heartbeat">Layer 0 — Init + Heartbeat <a class="heading-anchor" href="#layer-0-init-heartbeat" aria-label="Link to this section">#</a></h3>
<ul>
<li>[ ] <code>hiveloop.init()</code> added at application startup</li>
<li>[ ] <code>hb.agent()</code> called for each agent (static or dynamic)</li>
<li>[ ] Agent handles stored and accessible (registry pattern or instance attribute)</li>
<li>[ ] <strong>Verify:</strong> Agents visible in The Hive with green heartbeats</li>
</ul>
<h3 id="layer-1a-task-context">Layer 1a — Task context <a class="heading-anchor" href="#layer-1a-task-context" aria-label="Link to this section">#</a></h3>
<ul>
<li>[ ] Task entry point identified</li>
<li>[ ] <code>agent.task()</code> context manager wrapping the task boundary</li>
<li>[ ] Plumbing pattern chosen and implemented (<code>contextvars</code> recommended)</li>
<li>[ ] <code>set_current_task()</code> / <code>clear_current_task()</code> in <code>try/finally</code></li>
<li>[ ] <strong>Verify:</strong> Tasks appear in Task Table, PROCESSING badge shows during execution</li>
</ul>
<h3 id="layer-1b-action-tracking">Layer 1b — Action tracking <a class="heading-anchor" href="#layer-1b-action-tracking" aria-label="Link to this section">#</a></h3>
<ul>
<li>[ ] Top 5-7 tracked functions identified</li>
<li>[ ] Tracking applied (decorators, context managers, or runtime decoration)</li>
<li>[ ] <strong>Verify:</strong> Timeline shows action nodes with duration connectors</li>
</ul>
<h3 id="layer-2a-llm-calls-highest-value">Layer 2a — LLM calls (highest value) <a class="heading-anchor" href="#layer-2a-llm-calls-highest-value" aria-label="Link to this section">#</a></h3>
<ul>
<li>[ ] All LLM call sites identified</li>
<li>[ ] <code>task.llm_call()</code> added after each LLM call</li>
<li>[ ] Cost calculation implemented</li>
<li>[ ] <strong>Verify:</strong> Cost Explorer shows data, LLM nodes appear in Timeline (purple)</li>
</ul>
<h3 id="layer-2b-narrative-events">Layer 2b — Narrative events <a class="heading-anchor" href="#layer-2b-narrative-events" aria-label="Link to this section">#</a></h3>
<ul>
<li>[ ] Escalation points identified and <code>task.escalate()</code> added</li>
<li>[ ] Approval request/receive points identified and methods added</li>
<li>[ ] Plan creation/step points identified and methods added</li>
<li>[ ] Retry points identified and <code>task.retry()</code> added</li>
<li>[ ] Issue reporting points identified and <code>agent.report_issue()</code> added</li>
<li>[ ] <strong>Verify:</strong> Activity Stream shows rich event types, Pipeline tab populated</li>
</ul>
<h3 id="layer-2c-pipeline-enrichment-optional">Layer 2c — Pipeline enrichment (optional) <a class="heading-anchor" href="#layer-2c-pipeline-enrichment-optional" aria-label="Link to this section">#</a></h3>
<ul>
<li>[ ] <code>queue_provider</code> callback added to agent registration</li>
<li>[ ] <code>heartbeat_payload</code> callback added for custom status</li>
<li>[ ] <code>agent.scheduled()</code> called for recurring work</li>
<li>[ ] <code>agent.todo()</code> called for work item lifecycle</li>
<li>[ ] <strong>Verify:</strong> Agent cards show queue badges and issue indicators</li>
</ul>
<hr />
<h2 id="12-common-mistakes">12. Common Mistakes <a class="heading-anchor" href="#12-common-mistakes" aria-label="Link to this section">#</a></h2>
<h3 id="121-forgetting-the-finally-block">12.1 Forgetting the <code>finally</code> block <a class="heading-anchor" href="#121-forgetting-the-finally-block" aria-label="Link to this section">#</a></h3>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># ❌ Bug: if process() throws, current task is never cleared
with agent.task(task_id) as task:
    set_current_task(task)
    result = process(item)
    clear_current_task()  # never reached on exception

# ✅ Correct:
with agent.task(task_id) as task:
    set_current_task(task)
    try:
        result = process(item)
    finally:
        clear_current_task()
</code></pre></div>
<h3 id="122-using-the-wrong-agent-handle">12.2 Using the wrong agent handle <a class="heading-anchor" href="#122-using-the-wrong-agent-handle" aria-label="Link to this section">#</a></h3>
<p>In multi-agent systems, make sure the <code>agent.task()</code> uses the correct agent's handle:</p>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># ❌ Bug: always uses the same agent
with global_agent.task(task_id) as task:
    ...

# ✅ Correct: uses the agent that's actually doing the work
hiveloop_agent = get_hiveloop_agent(current_agent.name)
with hiveloop_agent.task(task_id) as task:
    ...
</code></pre></div>
<h3 id="123-tracking-too-many-functions">12.3 Tracking too many functions <a class="heading-anchor" href="#123-tracking-too-many-functions" aria-label="Link to this section">#</a></h3>
<p>If your timeline has 30+ nodes for one task, it's unreadable. Start with the top 5-7 and add more only if you need the detail for debugging specific issues.</p>
<h3 id="124-forgetting-to-create-the-project">12.4 Forgetting to create the project <a class="heading-anchor" href="#124-forgetting-to-create-the-project" aria-label="Link to this section">#</a></h3>
<p><code>agent.task(task_id, project=&quot;my-project&quot;)</code> will fail with a 207 partial rejection if <code>&quot;my-project&quot;</code> doesn't exist on the server. Create projects first via the API:</p>
<div class="code-block"><span class="code-lang">bash</span><pre><code class="language-bash">curl -X POST http://localhost:8000/v1/projects \
  -H &quot;Authorization: Bearer your-api-key&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{&quot;slug&quot;: &quot;my-project&quot;, &quot;name&quot;: &quot;My Project&quot;}'
</code></pre></div>
<h3 id="125-not-setting-the-env-var-in-both-terminals">12.5 Not setting the env var in both terminals <a class="heading-anchor" href="#125-not-setting-the-env-var-in-both-terminals" aria-label="Link to this section">#</a></h3>
<p>On Windows PowerShell, environment variables are per-terminal. If your HiveBoard server and your agent run in different terminals, both need:</p>
<div class="code-block"><span class="code-lang">powershell</span><pre><code class="language-powershell">$env:HIVEBOARD_DEV_KEY = &quot;hb_live_dev000000000000000000000000000000&quot;
</code></pre></div>
<p>On Linux/Mac:</p>
<div class="code-block"><span class="code-lang">bash</span><pre><code class="language-bash">export HIVEBOARD_DEV_KEY=&quot;hb_live_dev000000000000000000000000000000&quot;
</code></pre></div>
<h3 id="126-agent-name-mismatch">12.6 Agent name mismatch <a class="heading-anchor" href="#126-agent-name-mismatch" aria-label="Link to this section">#</a></h3>
<p>The <code>agent_id</code> in <code>hb.agent()</code> must exactly match what you use to look up the agent handle later. If your agent is named <code>&quot;lead-qualifier&quot;</code> but you look up <code>&quot;Lead Qualifier&quot;</code>, you'll get <code>None</code> and all instrumentation silently skips.</p>
<h3 id="127-calling-task-methods-outside-a-task-context">12.7 Calling task methods outside a task context <a class="heading-anchor" href="#127-calling-task-methods-outside-a-task-context" aria-label="Link to this section">#</a></h3>
<div class="code-block"><span class="code-lang">python</span><pre><code class="language-python"># ❌ Bug: no active task, so get_current_task() returns None
def some_startup_function():
    task = get_current_task()
    task.llm_call(...)  # AttributeError: 'NoneType' has no attribute 'llm_call'

# ✅ Use agent-level methods for calls outside task context:
agent.llm_call(&quot;startup_call&quot;, model=&quot;...&quot;, tokens_in=N, tokens_out=N)
</code></pre></div>

        </article>
        <div class="prev-next"><a class="prev-next-link prev" href="docs-dashboard-guide.html"><span class="prev-next-label">← Previous</span><span class="prev-next-title">Dashboard Guide</span></a><a class="prev-next-link next" href="docs-layer1-guide.html"><span class="prev-next-label">Next →</span><span class="prev-next-title">Layer 1 Guide</span></a></div>
    </main>

    <!-- RIGHT TOC -->
<nav class="page-toc"><div class="page-toc-title">On this page</div>
<a class="toc-link" href="#table-of-contents">Table of Contents</a>
<a class="toc-link" href="#1-the-instrumentation-mindset">1. The Instrumentation Mindset</a>
<a class="toc-link toc-h3" href="#the-golden-rule">The golden rule</a>
<a class="toc-link" href="#2-layer-0-recap-init-heartbeat">2. Layer 0 Recap — Init + Heartbeat</a>
<a class="toc-link" href="#3-finding-where-to-add-agenttask">3. Finding WHERE to Add agent.task()</a>
<a class="toc-link toc-h3" href="#31-what-is-a-task">3.1 What is a "task"?</a>
<a class="toc-link toc-h3" href="#32-how-to-find-the-task-boundary">3.2 How to find the task boundary</a>
<a class="toc-link toc-h3" href="#33-the-decision-checklist">3.3 The decision checklist</a>
<a class="toc-link toc-h3" href="#34-common-traps">3.4 Common traps</a>
<a class="toc-link toc-h3" href="#35-adding-agenttask">3.5 Adding agent.task()</a>
<a class="toc-link" href="#4-finding-where-to-add-agenttrack">4. Finding WHERE to Add @agent.track()</a>
<a class="toc-link toc-h3" href="#41-what-is-a-tracked-action">4.1 What is a "tracked action"?</a>
<a class="toc-link toc-h3" href="#42-the-selection-criteria">4.2 The selection criteria</a>
<a class="toc-link toc-h3" href="#43-the-5-7-nodes-rule">4.3 The "5-7 nodes" rule</a>
<a class="toc-link toc-h3" href="#44-finding-candidates-in-your-codebase">4.4 Finding candidates in your codebase</a>
<a class="toc-link toc-h3" href="#45-adding-tracking">4.5 Adding tracking</a>
<a class="toc-link" href="#5-plumbing-getting-the-task-object-where-you-need-it">5. Plumbing — Getting the Task Object Where You Need It</a>
<a class="toc-link toc-h3" href="#51-assess-your-call-depth">5.1 Assess your call depth</a>
<a class="toc-link toc-h3" href="#52-pattern-a-pass-as-parameter-shallow-stacks">5.2 Pattern A — Pass as parameter (shallow stacks)</a>
<a class="toc-link toc-h3" href="#53-pattern-b-contextvars-medium-to-deep-stacks">5.3 Pattern B — contextvars (medium to deep stacks)</a>
<a class="toc-link toc-h3" href="#54-pattern-c-framework-context-object-web-frameworks">5.4 Pattern C — Framework context object (web frameworks)</a>
<a class="toc-link toc-h3" href="#55-combining-patterns">5.5 Combining patterns</a>
<a class="toc-link" href="#6-implementation-patterns-for-classes-and-methods">6. Implementation Patterns for Classes and Methods</a>
<a class="toc-link toc-h3" href="#61-the-challenge">6.1 The challenge</a>
<a class="toc-link toc-h3" href="#62-pattern-a-context-manager-inside-the-method">6.2 Pattern A — Context manager inside the method</a>
<a class="toc-link toc-h3" href="#63-pattern-b-helper-function-to-reduce-boilerplate">6.3 Pattern B — Helper function to reduce boilerplate</a>
<a class="toc-link toc-h3" href="#64-pattern-c-dynamic-decorator-at-runtime">6.4 Pattern C — Dynamic decorator at runtime</a>
<a class="toc-link toc-h3" href="#65-pattern-d-use-task-events-instead-of-decorators">6.5 Pattern D — Use task events instead of decorators</a>
<a class="toc-link toc-h3" href="#66-which-pattern-should-i-use">6.6 Which pattern should I use?</a>
<a class="toc-link" href="#7-validating-your-instrumentation">7. Validating Your Instrumentation</a>
<a class="toc-link toc-h3" href="#71-validation-checklist-agenttask">7.1 Validation checklist — agent.task()</a>
<a class="toc-link toc-h3" href="#72-validation-checklist-agenttrack">7.2 Validation checklist — @agent.track()</a>
<a class="toc-link toc-h3" href="#73-validation-checklist-error-handling">7.3 Validation checklist — Error handling</a>
<a class="toc-link toc-h3" href="#74-quick-smoke-test-sequence">7.4 Quick smoke test sequence</a>
<a class="toc-link" href="#8-adding-layer-2-rich-events">8. Adding Layer 2 — Rich Events</a>
<a class="toc-link toc-h3" href="#81-priority-order">8.1 Priority order</a>
<a class="toc-link toc-h3" href="#82-finding-where-to-add-llm-calls">8.2 Finding WHERE to add LLM calls</a>
<a class="toc-link toc-h3" href="#83-finding-where-to-add-escalations-and-approvals">8.3 Finding WHERE to add escalations and approvals</a>
<a class="toc-link toc-h3" href="#84-finding-where-to-add-plans">8.4 Finding WHERE to add plans</a>
<a class="toc-link" href="#9-architecture-specific-guidance">9. Architecture-Specific Guidance</a>
<a class="toc-link toc-h3" href="#91-single-loop-agent">9.1 Single loop agent</a>
<a class="toc-link toc-h3" href="#92-multi-agent-system">9.2 Multi-agent system</a>
<a class="toc-link toc-h3" href="#93-api-driven-agent-fastapi">9.3 API-driven agent (FastAPI)</a>
<a class="toc-link toc-h3" href="#94-framework-based-langchain-crewai">9.4 Framework-based (LangChain, CrewAI)</a>
<a class="toc-link toc-h3" href="#95-scheduled-cron-based-agent">9.5 Scheduled / cron-based agent</a>
<a class="toc-link" href="#10-the-safety-contract">10. The Safety Contract</a>
<a class="toc-link toc-h3" href="#101-rules">10.1 Rules</a>
<a class="toc-link toc-h3" href="#102-testing-without-hiveboard">10.2 Testing without HiveBoard</a>
<a class="toc-link toc-h3" href="#103-the-if-task-guard">10.3 The if task: guard</a>
<a class="toc-link" href="#11-incremental-instrumentation-checklist">11. Incremental Instrumentation Checklist</a>
<a class="toc-link toc-h3" href="#layer-0-init-heartbeat">Layer 0 — Init + Heartbeat</a>
<a class="toc-link toc-h3" href="#layer-1a-task-context">Layer 1a — Task context</a>
<a class="toc-link toc-h3" href="#layer-1b-action-tracking">Layer 1b — Action tracking</a>
<a class="toc-link toc-h3" href="#layer-2a-llm-calls-highest-value">Layer 2a — LLM calls (highest value)</a>
<a class="toc-link toc-h3" href="#layer-2b-narrative-events">Layer 2b — Narrative events</a>
<a class="toc-link toc-h3" href="#layer-2c-pipeline-enrichment-optional">Layer 2c — Pipeline enrichment (optional)</a>
<a class="toc-link" href="#12-common-mistakes">12. Common Mistakes</a>
<a class="toc-link toc-h3" href="#121-forgetting-the-finally-block">12.1 Forgetting the finally block</a>
<a class="toc-link toc-h3" href="#122-using-the-wrong-agent-handle">12.2 Using the wrong agent handle</a>
<a class="toc-link toc-h3" href="#123-tracking-too-many-functions">12.3 Tracking too many functions</a>
<a class="toc-link toc-h3" href="#124-forgetting-to-create-the-project">12.4 Forgetting to create the project</a>
<a class="toc-link toc-h3" href="#125-not-setting-the-env-var-in-both-terminals">12.5 Not setting the env var in both terminals</a>
<a class="toc-link toc-h3" href="#126-agent-name-mismatch">12.6 Agent name mismatch</a>
<a class="toc-link toc-h3" href="#127-calling-task-methods-outside-a-task-context">12.7 Calling task methods outside a task context</a>
</nav>

</div>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js"></script>
<script>
// Re-highlight after load
Prism.highlightAll();

// Mobile menu toggle
document.getElementById('mobileMenuToggle')?.addEventListener('click', () => {
    document.getElementById('docsSidebar').classList.toggle('open');
});

// Close sidebar on content click (mobile)
document.querySelector('.docs-main')?.addEventListener('click', () => {
    document.getElementById('docsSidebar').classList.remove('open');
});

// Active TOC tracking
(function() {
    const tocLinks = document.querySelectorAll('.toc-link');
    if (!tocLinks.length) return;
    
    const headings = [];
    tocLinks.forEach(link => {
        const id = link.getAttribute('href')?.slice(1);
        const el = id && document.getElementById(id);
        if (el) headings.push({ el, link });
    });
    
    function updateActive() {
        let current = headings[0];
        for (const h of headings) {
            if (h.el.getBoundingClientRect().top <= 100) current = h;
        }
        tocLinks.forEach(l => l.classList.remove('active'));
        if (current) current.link.classList.add('active');
    }
    
    window.addEventListener('scroll', updateActive, { passive: true });
    updateActive();
})();

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', e => {
        const target = document.querySelector(a.getAttribute('href'));
        if (target) {
            e.preventDefault();
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            history.pushState(null, '', a.getAttribute('href'));
        }
    });
});
</script>
</body>
</html>
