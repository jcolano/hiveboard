<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HiveBoard — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --accent: #c2410c;
    --accent-dim: rgba(194, 65, 12, 0.06);
    --accent-hover: #a93b0b;
    --accent-light: rgba(194, 65, 12, 0.1);
    --font-mono: 'IBM Plex Mono', monospace;
    --font-sans: 'Plus Jakarta Sans', sans-serif;
    --radius-sm: 6px;
    --radius-md: 10px;
    --bg-deep: #f5f3ef;
    --bg-primary: #ffffff;
    --bg-card: #ffffff;
    --bg-elevated: #fafaf8;
    --bg-hover: #f0eeea;
    --border: #e2e0db;
    --border-subtle: #eceae5;
    --text-primary: #1a1a1a;
    --text-secondary: #4a4a4a;
    --text-muted: #8a8a8a;
    --success: #16a34a;
    --success-dim: rgba(22, 163, 74, 0.08);
    --error: #dc2626;
    --error-dim: rgba(220, 38, 38, 0.06);
    --warning: #d97706;
    --warning-dim: rgba(217, 119, 6, 0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: var(--font-sans);
    background: var(--bg-deep);
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
}

@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes fade-in-up { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slide-down { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { to { transform: rotate(360deg); } }

/* ═══════════════════════════════════════
   TOP BAR
   ═══════════════════════════════════════ */
.topbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; height: 56px;
    background: var(--bg-primary); border-bottom: 1px solid var(--border);
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
}
.topbar-left { display: flex; align-items: center; gap: 16px; }
.logo {
    display: flex; align-items: center; gap: 10px;
    font-family: var(--font-sans); font-weight: 800; font-size: 17px;
    letter-spacing: -0.5px; text-decoration: none; color: var(--text-primary);
}
.logo-hex {
    width: 28px; height: 28px; background: var(--accent);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.logo-hex-inner {
    width: 18px; height: 18px; background: var(--bg-primary);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
}
.logo span { color: var(--accent); }

.topbar-right { display: flex; align-items: center; gap: 12px; }

/* ─── USER MENU ─── */
.user-menu-wrapper { position: relative; }
.user-trigger {
    display: flex; align-items: center; gap: 10px;
    padding: 5px 12px 5px 5px;
    border: 1px solid var(--border); border-radius: 28px;
    background: var(--bg-primary); cursor: pointer; transition: all 0.15s;
}
.user-trigger:hover { background: var(--bg-hover); border-color: #ccc; }
.user-avatar {
    width: 30px; height: 30px; border-radius: 50%;
    background: var(--accent); color: #fff;
    font-family: var(--font-sans); font-size: 13px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.user-name {
    font-family: var(--font-sans); font-size: 13px; font-weight: 600;
    color: var(--text-secondary); max-width: 140px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.user-chevron { color: var(--text-muted); transition: transform 0.2s; flex-shrink: 0; }
.user-trigger.open .user-chevron { transform: rotate(180deg); }

.user-dropdown {
    position: absolute; top: calc(100% + 8px); right: 0; width: 260px;
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: var(--radius-md);
    box-shadow: 0 8px 30px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.04);
    display: none; z-index: 200; overflow: hidden; animation: slide-down 0.2s ease;
}
.user-dropdown.open { display: block; }

.dropdown-user-info { padding: 16px; border-bottom: 1px solid var(--border); }
.dropdown-user-name { font-family: var(--font-sans); font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 2px; }
.dropdown-user-email { font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); }
.dropdown-user-role {
    display: inline-block; margin-top: 6px;
    font-family: var(--font-sans); font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--accent); background: var(--accent-dim);
    padding: 2px 8px; border-radius: 4px;
}
.dropdown-section { padding: 6px; }
.dropdown-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: var(--radius-sm);
    cursor: pointer; transition: background 0.1s;
    font-family: var(--font-sans); font-size: 14px; font-weight: 500;
    color: var(--text-secondary); border: none; background: none; width: 100%; text-align: left;
}
.dropdown-item:hover { background: var(--bg-hover); }
.dropdown-item svg { color: var(--text-muted); flex-shrink: 0; }
.dropdown-divider { height: 1px; background: var(--border); }
.dropdown-item.danger { color: var(--error); }
.dropdown-item.danger svg { color: var(--error); }

/* ═══════════════════════════════════════
   APP LAYOUT: SIDEBAR + MAIN
   ═══════════════════════════════════════ */
.app-layout {
    display: flex; min-height: 100vh; padding-top: 56px;
}

/* ─── SIDEBAR ─── */
.sidebar {
    width: 220px; flex-shrink: 0;
    background: var(--bg-primary);
    border-right: 1px solid var(--border);
    padding: 16px 10px;
    position: fixed; top: 56px; bottom: 0; left: 0;
    overflow-y: auto;
}
.sidebar-section-label {
    font-family: var(--font-sans); font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--text-muted); padding: 12px 12px 6px; margin-top: 8px;
}
.sidebar-section-label:first-child { margin-top: 0; }

.nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 12px; border-radius: var(--radius-sm);
    cursor: pointer; transition: all 0.12s;
    font-family: var(--font-sans); font-size: 14px; font-weight: 500;
    color: var(--text-secondary); border: none; background: none; width: 100%; text-align: left;
}
.nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.nav-item.active {
    background: var(--accent-dim); color: var(--accent); font-weight: 600;
}
.nav-item svg { width: 18px; height: 18px; flex-shrink: 0; opacity: 0.6; }
.nav-item.active svg { opacity: 1; color: var(--accent); }

/* ─── MAIN CONTENT ─── */
.main-area {
    flex: 1; margin-left: 220px; padding: 32px;
    max-width: 960px;
    animation: fade-in 0.3s ease;
}

.panel { display: none; }
.panel.active { display: block; animation: fade-in-up 0.3s ease; }

/* ═══════════════════════════════════════
   SHARED PANEL STYLES
   ═══════════════════════════════════════ */
.panel-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px;
}
.panel-title {
    font-family: var(--font-sans); font-size: 22px; font-weight: 800;
    letter-spacing: -0.5px;
}
.panel-title .hl { color: var(--accent); }
.panel-desc {
    font-family: var(--font-sans); font-size: 14px; color: var(--text-muted);
    margin-top: 2px;
}

.btn-primary {
    display: inline-flex; align-items: center; gap: 6px;
    font-family: var(--font-sans); font-size: 13px; font-weight: 700;
    color: #fff; background: var(--accent); border: none;
    padding: 9px 16px; border-radius: var(--radius-sm);
    cursor: pointer; transition: all 0.15s;
}
.btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-secondary {
    display: inline-flex; align-items: center; gap: 6px;
    font-family: var(--font-sans); font-size: 13px; font-weight: 600;
    color: var(--text-secondary); background: var(--bg-primary);
    border: 1px solid var(--border); padding: 8px 14px;
    border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s;
}
.btn-secondary:hover { background: var(--bg-hover); }

.btn-danger-sm {
    font-family: var(--font-sans); font-size: 12px; font-weight: 600;
    color: var(--error); background: var(--error-dim);
    border: 1px solid rgba(220,38,38,0.15); padding: 5px 12px;
    border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s;
}
.btn-danger-sm:hover { background: rgba(220,38,38,0.12); }

/* ─── CARDS & LISTS ─── */
.card {
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: var(--radius-md); overflow: hidden;
}
.card-empty {
    padding: 40px 24px; text-align: center;
    font-family: var(--font-sans); font-size: 14px; color: var(--text-muted);
}
.list-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 20px; border-bottom: 1px solid var(--border-subtle);
    transition: background 0.1s;
}
.list-row:last-child { border-bottom: none; }
.list-row:hover { background: var(--bg-elevated); }
.list-row-info { flex: 1; min-width: 0; }
.list-row-title {
    font-family: var(--font-sans); font-size: 14px; font-weight: 600;
    color: var(--text-primary); margin-bottom: 2px;
}
.list-row-meta {
    font-family: var(--font-mono); font-size: 12px; color: var(--text-muted);
}
.list-row-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; margin-left: 16px; }

.badge {
    display: inline-block; font-family: var(--font-sans); font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.4px;
    padding: 2px 8px; border-radius: 4px;
}
.badge-accent { color: var(--accent); background: var(--accent-dim); }
.badge-green { color: var(--success); background: var(--success-dim); }
.badge-muted { color: var(--text-muted); background: var(--bg-deep); }

/* ─── INLINE FORM (for creating items) ─── */
.inline-form {
    background: var(--bg-elevated); border: 1px solid var(--border);
    border-radius: var(--radius-md); padding: 20px;
    margin-bottom: 20px; display: none;
    animation: fade-in-up 0.25s ease;
}
.inline-form.open { display: block; }
.inline-form-title {
    font-family: var(--font-sans); font-size: 14px; font-weight: 700;
    margin-bottom: 14px; color: var(--text-primary);
}
.inline-form-row {
    display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;
}
.inline-field { flex: 1; min-width: 160px; }
.inline-field label {
    display: block; font-family: var(--font-sans); font-size: 12px; font-weight: 600;
    color: var(--text-muted); margin-bottom: 4px;
}
.inline-field input, .inline-field select {
    width: 100%; font-family: var(--font-sans); font-size: 14px;
    color: var(--text-primary); background: var(--bg-primary);
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 9px 12px; outline: none; transition: border-color 0.15s;
}
.inline-field input:focus, .inline-field select:focus {
    border-color: var(--accent); box-shadow: 0 0 0 2px rgba(194,65,12,0.08);
}
.inline-field input.input-error { border-color: var(--error); }
.inline-form-actions { display: flex; gap: 8px; align-items: flex-end; padding-top: 4px; }
.inline-error {
    font-family: var(--font-sans); font-size: 13px; color: var(--error);
    margin-top: 10px; display: none;
}
.inline-error.visible { display: block; }

/* ─── KEY REVEAL BOX ─── */
.key-reveal {
    background: var(--accent-dim); border: 1.5px solid rgba(194,65,12,0.2);
    border-radius: var(--radius-md); padding: 16px 20px; margin-bottom: 20px;
    display: none; animation: fade-in-up 0.3s ease;
}
.key-reveal.visible { display: block; }
.key-reveal-label {
    font-family: var(--font-sans); font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent); margin-bottom: 8px;
}
.key-reveal-row { display: flex; align-items: center; gap: 10px; }
.key-reveal-text {
    flex: 1; font-family: var(--font-mono); font-size: 13px; font-weight: 600;
    color: var(--text-primary); background: var(--bg-primary);
    padding: 9px 12px; border-radius: var(--radius-sm);
    border: 1px solid var(--border); word-break: break-all; user-select: all;
}
.key-reveal-warn {
    font-family: var(--font-sans); font-size: 12px; color: var(--warning);
    margin-top: 8px; display: flex; align-items: center; gap: 4px;
}

/* ─── INVITE LINK BOX ─── */
.invite-link-box {
    background: var(--success-dim); border: 1.5px solid rgba(22,163,74,0.2);
    border-radius: var(--radius-md); padding: 16px 20px; margin-bottom: 20px;
    display: none; animation: fade-in-up 0.3s ease;
}
.invite-link-box.visible { display: block; }
.invite-link-label {
    font-family: var(--font-sans); font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px; color: var(--success); margin-bottom: 8px;
}
.invite-link-row { display: flex; align-items: center; gap: 10px; }
.invite-link-text {
    flex: 1; font-family: var(--font-mono); font-size: 12px;
    color: var(--text-primary); background: var(--bg-primary);
    padding: 9px 12px; border-radius: var(--radius-sm);
    border: 1px solid var(--border); word-break: break-all; user-select: all;
}
.invite-link-hint {
    font-family: var(--font-sans); font-size: 12px; color: var(--text-muted);
    margin-top: 8px;
}

/* ═══════════════════════════════════════
   EMPTY STATE (Dashboard)
   ═══════════════════════════════════════ */
.empty-state {
    background: var(--bg-primary); border: 2px dashed var(--border);
    border-radius: 12px; padding: 60px 40px; text-align: center;
}
.empty-hex {
    width: 56px; height: 56px; background: var(--accent-dim);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 16px; font-size: 20px; color: var(--accent);
}
.empty-title { font-family: var(--font-sans); font-size: 17px; font-weight: 700; margin-bottom: 6px; }
.empty-text { font-family: var(--font-sans); font-size: 14px; color: var(--text-muted); max-width: 380px; margin: 0 auto 20px; line-height: 1.5; }
.empty-code {
    display: inline-block; font-family: var(--font-mono); font-size: 14px; font-weight: 600;
    color: var(--accent); background: var(--accent-dim);
    padding: 8px 20px; border-radius: var(--radius-sm); border: 1px solid rgba(194,65,12,0.15);
}

/* ═══════════════════════════════════════
   MODAL (shared)
   ═══════════════════════════════════════ */
.modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.4); z-index: 500;
    align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal-card {
    background: var(--bg-primary); border-radius: 12px;
    width: 100%; max-width: 440px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    animation: fade-in-up 0.3s ease; overflow: hidden;
}
.modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px; border-bottom: 1px solid var(--border);
}
.modal-title { font-family: var(--font-sans); font-size: 17px; font-weight: 700; }
.modal-close {
    width: 32px; height: 32px; border: none; background: var(--bg-deep);
    border-radius: 8px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); transition: all 0.15s;
}
.modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
.modal-body { padding: 24px; }
.modal-body p { font-family: var(--font-sans); font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 16px; }
.modal-footer {
    display: flex; justify-content: flex-end; gap: 10px;
    padding: 16px 24px; border-top: 1px solid var(--border);
}
.btn-close-modal {
    font-family: var(--font-sans); font-size: 14px; font-weight: 600;
    color: var(--text-secondary); background: var(--bg-deep);
    border: 1px solid var(--border); padding: 9px 20px;
    border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s;
}
.btn-close-modal:hover { background: var(--bg-hover); }
.btn-danger {
    font-family: var(--font-sans); font-size: 14px; font-weight: 700;
    color: #fff; background: var(--error); border: none;
    padding: 9px 20px; border-radius: var(--radius-sm);
    cursor: pointer; transition: all 0.15s;
}
.btn-danger:hover { background: #b91c1c; }

.profile-field { margin-bottom: 18px; }
.profile-label {
    display: block; font-family: var(--font-sans); font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-muted); margin-bottom: 4px;
}
.profile-value { font-family: var(--font-sans); font-size: 15px; font-weight: 500; color: var(--text-primary); padding: 8px 0; }
.profile-value.mono { font-family: var(--font-mono); font-size: 13px; }
.profile-row { display: flex; gap: 24px; }
.profile-row .profile-field { flex: 1; }

/* ─── RESPONSIVE ─── */
@media (max-width: 768px) {
    .sidebar { width: 56px; padding: 12px 6px; }
    .sidebar .nav-item span { display: none; }
    .sidebar .sidebar-section-label { display: none; }
    .main-area { margin-left: 56px; padding: 20px 16px; }
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════
     TOP BAR
     ═══════════════════════════════════════ -->
<div class="topbar">
    <div class="topbar-left">
        <a href="home.html" class="logo">
            <div class="logo-hex"><div class="logo-hex-inner"></div></div>
            Hive<span>Board</span>
        </a>
    </div>
    <div class="topbar-right">
        <div class="user-menu-wrapper">
            <button class="user-trigger" id="userTrigger">
                <div class="user-avatar" id="userAvatar">—</div>
                <span class="user-name" id="userNameDisplay">—</span>
                <svg class="user-chevron" width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M3.5 5.5L7 9l3.5-3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-user-info">
                    <div class="dropdown-user-name" id="dropdownName">—</div>
                    <div class="dropdown-user-email" id="dropdownEmail">—</div>
                    <div class="dropdown-user-role" id="dropdownRole">—</div>
                </div>
                <div class="dropdown-section">
                    <button class="dropdown-item" id="openProfile">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="5" r="3" stroke="currentColor" stroke-width="1.3"/><path d="M2 14c0-3.3 2.7-5 6-5s6 1.7 6 5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
                        Profile
                    </button>
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-section">
                    <button class="dropdown-item danger" id="logoutBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 2H4a2 2 0 00-2 2v8a2 2 0 002 2h2M10.5 11.5L14 8l-3.5-3.5M14 8H6" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Sign out
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════ -->
<div class="app-layout">
<nav class="sidebar">
    <div class="sidebar-section-label">Overview</div>
    <button class="nav-item active" data-panel="dashboard">
        <svg viewBox="0 0 18 18" fill="none"><rect x="1" y="1" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.3"/><rect x="10" y="1" width="7" height="4" rx="1.5" stroke="currentColor" stroke-width="1.3"/><rect x="1" y="10" width="7" height="4" rx="1.5" stroke="currentColor" stroke-width="1.3"/><rect x="10" y="7" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.3"/></svg>
        <span>Dashboard</span>
    </button>

    <div class="sidebar-section-label">Workspace</div>
    <button class="nav-item" data-panel="projects">
        <svg viewBox="0 0 18 18" fill="none"><path d="M2 5.5V14a1.5 1.5 0 001.5 1.5h11A1.5 1.5 0 0016 14V7a1.5 1.5 0 00-1.5-1.5H9L7.5 3.5H3.5A1.5 1.5 0 002 5z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/></svg>
        <span>Projects</span>
    </button>
    <button class="nav-item" data-panel="apikeys">
        <svg viewBox="0 0 18 18" fill="none"><path d="M11.5 7.5a4 4 0 10-2 3.46L11 12.5h1.5V14H14v-1.5h1.5v-2h-3L11.5 9.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/><circle cx="7" cy="7.5" r="1.2" fill="currentColor"/></svg>
        <span>API Keys</span>
    </button>
    <button class="nav-item" data-panel="team" id="navTeam" style="display:none">
        <svg viewBox="0 0 18 18" fill="none"><circle cx="7" cy="5.5" r="2.5" stroke="currentColor" stroke-width="1.3"/><path d="M1.5 15c0-3 2.5-4.5 5.5-4.5s5.5 1.5 5.5 4.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><path d="M12 4.5a2.5 2.5 0 010 5M14 10.5c2 .7 3 2 3 4.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
        <span>Team</span>
    </button>
</nav>

<!-- ═══════════════════════════════════════
     MAIN PANELS
     ═══════════════════════════════════════ -->
<main class="main-area">

    <!-- ─── DASHBOARD ─── -->
    <div class="panel active" id="panel-dashboard">
        <div class="panel-header">
            <div>
                <div class="panel-title">Welcome, <span class="hl" id="welcomeName">—</span></div>
                <div class="panel-desc">Here's what your agents are up to.</div>
            </div>
        </div>
        <div class="empty-state">
            <div class="empty-hex">⬡</div>
            <div class="empty-title">No agents connected yet</div>
            <div class="empty-text">Install HiveLoop in your agent project to start seeing real-time observability data here.</div>
            <code class="empty-code">pip install hiveloop</code>
        </div>
    </div>

    <!-- ─── PROJECTS ─── -->
    <div class="panel" id="panel-projects">
        <div class="panel-header">
            <div>
                <div class="panel-title"><span class="hl">Projects</span></div>
                <div class="panel-desc">Organize agents and events by project.</div>
            </div>
            <button class="btn-primary" id="toggleCreateProject">+ New Project</button>
        </div>

        <div class="inline-form" id="createProjectForm">
            <div class="inline-form-title">Create a new project</div>
            <div class="inline-form-row">
                <div class="inline-field" style="flex:2">
                    <label for="projName">Name</label>
                    <input type="text" id="projName" placeholder="Sales Pipeline">
                </div>
                <div class="inline-field">
                    <label for="projEnv">Environment</label>
                    <select id="projEnv">
                        <option value="production">Production</option>
                        <option value="staging">Staging</option>
                        <option value="development">Development</option>
                    </select>
                </div>
            </div>
            <div class="inline-form-row" style="margin-top:10px">
                <div class="inline-field" style="flex:1">
                    <label for="projDesc">Description (optional)</label>
                    <input type="text" id="projDesc" placeholder="Tracks sales agent events">
                </div>
                <div class="inline-form-actions">
                    <button class="btn-primary" id="submitProject">Create</button>
                    <button class="btn-secondary" id="cancelProject">Cancel</button>
                </div>
            </div>
            <div class="inline-error" id="projError"></div>
        </div>

        <!-- Edit form (hidden by default, reused) -->
        <div class="inline-form" id="editProjectForm">
            <div class="inline-form-title">Edit project</div>
            <input type="hidden" id="editProjId">
            <div class="inline-form-row">
                <div class="inline-field" style="flex:2">
                    <label for="editProjName">Name</label>
                    <input type="text" id="editProjName">
                </div>
                <div class="inline-field">
                    <label for="editProjEnv">Environment</label>
                    <select id="editProjEnv">
                        <option value="production">Production</option>
                        <option value="staging">Staging</option>
                        <option value="development">Development</option>
                    </select>
                </div>
            </div>
            <div class="inline-form-row" style="margin-top:10px">
                <div class="inline-field" style="flex:1">
                    <label for="editProjDesc">Description</label>
                    <input type="text" id="editProjDesc">
                </div>
                <div class="inline-form-actions">
                    <button class="btn-primary" id="submitEditProject">Save</button>
                    <button class="btn-secondary" id="cancelEditProject">Cancel</button>
                </div>
            </div>
            <div class="inline-error" id="editProjError"></div>
        </div>

        <div class="card" id="projectList">
            <div class="card-empty">Loading projects…</div>
        </div>
    </div>

    <!-- ─── API KEYS ─── -->
    <div class="panel" id="panel-apikeys">
        <div class="panel-header">
            <div>
                <div class="panel-title"><span class="hl">API Keys</span></div>
                <div class="panel-desc">Manage keys for authenticating HiveLoop and the API.</div>
            </div>
            <button class="btn-primary" id="toggleCreateKey">+ New Key</button>
        </div>

        <div class="key-reveal" id="newKeyReveal">
            <div class="key-reveal-label">New API Key Created</div>
            <div class="key-reveal-row">
                <div class="key-reveal-text" id="newKeyValue">—</div>
                <button class="btn-secondary" id="copyNewKey">Copy</button>
            </div>
            <div class="key-reveal-warn">⚠ Save this key now — it won't be shown again.</div>
        </div>

        <div class="inline-form" id="createKeyForm">
            <div class="inline-form-title">Create a new API key</div>
            <div class="inline-form-row">
                <div class="inline-field" style="flex:2">
                    <label for="keyLabel">Label</label>
                    <input type="text" id="keyLabel" placeholder="Production Key">
                </div>
                <div class="inline-field">
                    <label for="keyType">Type</label>
                    <select id="keyType">
                        <option value="live">Live</option>
                        <option value="test">Test</option>
                        <option value="read">Read-only</option>
                    </select>
                </div>
                <div class="inline-form-actions">
                    <button class="btn-primary" id="submitKey">Create</button>
                    <button class="btn-secondary" id="cancelKey">Cancel</button>
                </div>
            </div>
            <div class="inline-error" id="keyError"></div>
        </div>

        <div class="card" id="keyList">
            <div class="card-empty">Loading API keys…</div>
        </div>
    </div>

    <!-- ─── TEAM ─── -->
    <div class="panel" id="panel-team">
        <div class="panel-header">
            <div>
                <div class="panel-title"><span class="hl">Team</span></div>
                <div class="panel-desc">Invite members to your workspace.</div>
            </div>
            <button class="btn-primary" id="toggleInvite">+ Invite Member</button>
        </div>

        <div class="invite-link-box" id="inviteLinkBox">
            <div class="invite-link-label">Invitation Link Created</div>
            <div class="invite-link-row">
                <div class="invite-link-text" id="inviteLinkValue">—</div>
                <button class="btn-secondary" id="copyInviteLink">Copy</button>
            </div>
            <div class="invite-link-hint">Share this link manually with the invited person. They'll use it to create their account and join your workspace.</div>
        </div>

        <div class="inline-form" id="inviteForm">
            <div class="inline-form-title">Send an invitation</div>
            <div class="inline-form-row">
                <div class="inline-field" style="flex:2">
                    <label for="inviteEmail">Email</label>
                    <input type="email" id="inviteEmail" placeholder="newmember@company.com">
                </div>
                <div class="inline-field">
                    <label for="inviteRole">Role</label>
                    <select id="inviteRole">
                        <option value="member">Member</option>
                        <option value="viewer">Viewer</option>
                        <option value="admin" id="roleOptionAdmin" style="display:none">Admin</option>
                        <option value="owner" id="roleOptionOwner" style="display:none">Owner</option>
                    </select>
                </div>
                <div class="inline-form-actions">
                    <button class="btn-primary" id="submitInvite">Send</button>
                    <button class="btn-secondary" id="cancelInvite">Cancel</button>
                </div>
            </div>
            <div class="inline-error" id="inviteError"></div>
        </div>

        <div class="card" id="inviteList">
            <div class="card-empty">Loading invitations…</div>
        </div>
    </div>

</main>
</div>

<!-- ═══════════════════════════════════════
     PROFILE MODAL
     ═══════════════════════════════════════ -->
<div class="modal-overlay" id="profileModal">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">Profile</div>
            <button class="modal-close" id="closeModal">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M12 4L4 12M4 4l8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="profile-field">
                <span class="profile-label">Name</span>
                <div class="profile-value" id="profileName">—</div>
            </div>
            <div class="profile-field">
                <span class="profile-label">Email</span>
                <div class="profile-value mono" id="profileEmail">—</div>
            </div>
            <div class="profile-row">
                <div class="profile-field">
                    <span class="profile-label">Role</span>
                    <div class="profile-value" id="profileRole">—</div>
                </div>
                <div class="profile-field">
                    <span class="profile-label">Tenant</span>
                    <div class="profile-value mono" id="profileTenant">—</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-close-modal" id="closeProfileBtn">Close</button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════
     CONFIRM DELETE MODAL
     ═══════════════════════════════════════ -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title" id="confirmTitle">Confirm</div>
            <button class="modal-close" id="closeConfirm">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M12 4L4 12M4 4l8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Are you sure?</p>
        </div>
        <div class="modal-footer">
            <button class="btn-close-modal" id="confirmCancel">Cancel</button>
            <button class="btn-danger" id="confirmAction">Delete</button>
        </div>
    </div>
</div>

<script>
// ═══════════════════════════════════════
// API CONFIG & AUTH
// ═══════════════════════════════════════
const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:8000'
    : 'https://api.hiveboard.ai';

function decodeJwtPayload(token) {
    try {
        const parts = token.split('.');
        if (parts.length !== 3) return null;
        const payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(atob(payload));
    } catch { return null; }
}

function isTokenExpired(token) {
    const payload = decodeJwtPayload(token);
    if (!payload || !payload.exp) return true;
    return Date.now() >= (payload.exp * 1000) - 30000;
}

async function apiCall(endpoint, method = 'GET', data = null) {
    const token = localStorage.getItem('hb_token');
    if (!token || isTokenExpired(token)) { logout(); throw new Error('Token expired'); }

    const headers = { 'Authorization': 'Bearer ' + token };
    const opts = { method, headers };

    if (data && method !== 'GET') {
        headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(data);
    }

    const resp = await fetch(API_BASE + endpoint, opts);
    if (resp.status === 401) { logout(); throw new Error('Unauthorized'); }

    const body = await resp.json().catch(() => ({}));
    return { status: resp.status, ok: resp.ok, data: body };
}

// ═══════════════════════════════════════
// AUTH CHECK
// ═══════════════════════════════════════
const token = localStorage.getItem('hb_token');
if (!token || isTokenExpired(token)) {
    logout();
} else {
    initApp();
}

function getUserData() {
    try { return JSON.parse(localStorage.getItem('hb_user')) || {}; } catch { return {}; }
}

function getUserRole() { return getUserData().role || 'viewer'; }
function isOwnerOrAdmin() { return ['owner', 'admin'].includes(getUserRole()); }

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
function initApp() {
    populateUI();
    setupNav();
    setupDropdown();
    setupProfileModal();

    // Show team nav if owner/admin
    if (isOwnerOrAdmin()) {
        document.getElementById('navTeam').style.display = '';
        // Show extra role options for owners
        if (getUserRole() === 'owner') {
            document.getElementById('roleOptionAdmin').style.display = '';
            document.getElementById('roleOptionOwner').style.display = '';
        }
    }

    setupProjects();
    setupApiKeys();
    if (isOwnerOrAdmin()) setupTeam();
}

function populateUI() {
    const user = getUserData();
    const name = user.name || user.email || 'User';
    const nameParts = name.split(' ');
    const initials = nameParts.length >= 2
        ? (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase()
        : name.slice(0, 2).toUpperCase();
    const firstName = nameParts[0] || 'there';

    document.getElementById('userAvatar').textContent = initials;
    document.getElementById('userNameDisplay').textContent = firstName;
    document.getElementById('dropdownName').textContent = name;
    document.getElementById('dropdownEmail').textContent = user.email || '';
    document.getElementById('dropdownRole').textContent = user.role || 'member';
    document.getElementById('welcomeName').textContent = firstName;

    document.getElementById('profileName').textContent = name;
    document.getElementById('profileEmail').textContent = user.email || '—';
    document.getElementById('profileRole').textContent = user.role || '—';
    document.getElementById('profileTenant').textContent = user.tenant_id || '—';
}

// ═══════════════════════════════════════
// SIDEBAR NAVIGATION
// ═══════════════════════════════════════
function setupNav() {
    document.querySelectorAll('.nav-item[data-panel]').forEach(btn => {
        btn.addEventListener('click', function() {
            const panelId = this.dataset.panel;
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            const panel = document.getElementById('panel-' + panelId);
            if (panel) panel.classList.add('active');
        });
    });
}

// ═══════════════════════════════════════
// USER DROPDOWN
// ═══════════════════════════════════════
function setupDropdown() {
    const trigger = document.getElementById('userTrigger');
    const dropdown = document.getElementById('userDropdown');

    trigger.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = dropdown.classList.toggle('open');
        trigger.classList.toggle('open', isOpen);
    });

    document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && !trigger.contains(e.target)) {
            dropdown.classList.remove('open');
            trigger.classList.remove('open');
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', logout);
}

// ═══════════════════════════════════════
// PROFILE MODAL
// ═══════════════════════════════════════
function setupProfileModal() {
    const modal = document.getElementById('profileModal');
    const trigger = document.getElementById('userTrigger');
    const dropdown = document.getElementById('userDropdown');

    document.getElementById('openProfile').addEventListener('click', function() {
        dropdown.classList.remove('open');
        trigger.classList.remove('open');
        modal.classList.add('open');
    });

    document.getElementById('closeModal').addEventListener('click', () => modal.classList.remove('open'));
    document.getElementById('closeProfileBtn').addEventListener('click', () => modal.classList.remove('open'));
    modal.addEventListener('click', function(e) { if (e.target === modal) modal.classList.remove('open'); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeAllModals(); });
}

function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
}

// ═══════════════════════════════════════
// CONFIRM MODAL (reusable)
// ═══════════════════════════════════════
let pendingConfirmAction = null;

function showConfirm(title, message, actionLabel, onConfirm) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmAction').textContent = actionLabel;
    pendingConfirmAction = onConfirm;
    document.getElementById('confirmModal').classList.add('open');
}

document.getElementById('confirmCancel').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.remove('open');
    pendingConfirmAction = null;
});
document.getElementById('closeConfirm').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.remove('open');
    pendingConfirmAction = null;
});
document.getElementById('confirmAction').addEventListener('click', async () => {
    if (pendingConfirmAction) {
        await pendingConfirmAction();
        pendingConfirmAction = null;
    }
    document.getElementById('confirmModal').classList.remove('open');
});

// ═══════════════════════════════════════
// LOGOUT
// ═══════════════════════════════════════
function logout() {
    localStorage.removeItem('hb_token');
    localStorage.removeItem('hb_token_type');
    localStorage.removeItem('hb_user');
    sessionStorage.clear();
    window.location.href = 'login.html';
}

// ═══════════════════════════════════════
// HELPER: slug from name
// ═══════════════════════════════════════
function toSlug(name) {
    return name.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
}

// ═══════════════════════════════════════
// HELPER: format date
// ═══════════════════════════════════════
function fmtDate(iso) {
    if (!iso) return '—';
    try { return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
    catch { return iso; }
}

// ═══════════════════════════════════════
// HELPER: copy to clipboard
// ═══════════════════════════════════════
function copyText(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = orig; }, 1500);
    });
}


// ═══════════════════════════════════════════════════════════════
//  P R O J E C T S
// ═══════════════════════════════════════════════════════════════
function setupProjects() {
    const createForm = document.getElementById('createProjectForm');
    const editForm = document.getElementById('editProjectForm');

    document.getElementById('toggleCreateProject').addEventListener('click', () => {
        createForm.classList.toggle('open');
        editForm.classList.remove('open');
    });
    document.getElementById('cancelProject').addEventListener('click', () => createForm.classList.remove('open'));

    document.getElementById('submitProject').addEventListener('click', createProject);
    document.getElementById('cancelEditProject').addEventListener('click', () => editForm.classList.remove('open'));
    document.getElementById('submitEditProject').addEventListener('click', saveEditProject);

    loadProjects();
}

async function loadProjects() {
    const container = document.getElementById('projectList');
    try {
        const res = await apiCall('/v1/projects', 'GET');
        if (!res.ok) { container.innerHTML = '<div class="card-empty">Failed to load projects.</div>'; return; }

        const projects = res.data.data || [];
        if (projects.length === 0) {
            container.innerHTML = '<div class="card-empty">No projects yet. Create one to get started.</div>';
            return;
        }

        container.innerHTML = projects.map(p => `
            <div class="list-row" data-id="${p.project_id}">
                <div class="list-row-info">
                    <div class="list-row-title">${esc(p.name)} <span class="badge badge-muted">${esc(p.slug)}</span></div>
                    <div class="list-row-meta">
                        ${esc(p.environment || 'production')}${p.description ? ' · ' + esc(p.description) : ''}
                        · ${p.event_count ?? 0} events
                    </div>
                </div>
                <div class="list-row-actions">
                    <button class="btn-secondary" onclick="editProject('${p.project_id}', '${esc(p.name)}', '${esc(p.description || '')}', '${esc(p.environment || 'production')}')">Edit</button>
                    ${p.slug !== 'default' ? `<button class="btn-danger-sm" onclick="deleteProject('${p.project_id}', '${esc(p.name)}')">Delete</button>` : '<span class="badge badge-accent">default</span>'}
                </div>
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<div class="card-empty">Failed to load projects.</div>';
    }
}

async function createProject() {
    const nameInput = document.getElementById('projName');
    const name = nameInput.value.trim();
    const errEl = document.getElementById('projError');
    errEl.classList.remove('visible');

    if (!name) { nameInput.classList.add('input-error'); return; }
    nameInput.classList.remove('input-error');

    const slug = toSlug(name);
    const desc = document.getElementById('projDesc').value.trim() || null;
    const env = document.getElementById('projEnv').value;

    try {
        const res = await apiCall('/v1/projects', 'POST', { name, slug, description: desc, environment: env });
        if (res.ok) {
            document.getElementById('createProjectForm').classList.remove('open');
            nameInput.value = ''; document.getElementById('projDesc').value = '';
            loadProjects();
        } else {
            errEl.textContent = res.data.message || res.data.detail || 'Failed to create project. The slug might already be taken.';
            errEl.classList.add('visible');
        }
    } catch (err) {
        errEl.textContent = 'Unable to connect.';
        errEl.classList.add('visible');
    }
}

function editProject(id, name, desc, env) {
    document.getElementById('editProjectForm').classList.add('open');
    document.getElementById('createProjectForm').classList.remove('open');
    document.getElementById('editProjId').value = id;
    document.getElementById('editProjName').value = name;
    document.getElementById('editProjDesc').value = desc;
    document.getElementById('editProjEnv').value = env;
    document.getElementById('editProjError').classList.remove('visible');
}

async function saveEditProject() {
    const id = document.getElementById('editProjId').value;
    const name = document.getElementById('editProjName').value.trim();
    const errEl = document.getElementById('editProjError');
    errEl.classList.remove('visible');

    if (!name) return;

    const slug = toSlug(name);
    const desc = document.getElementById('editProjDesc').value.trim() || null;
    const env = document.getElementById('editProjEnv').value;

    try {
        const res = await apiCall('/v1/projects/' + id, 'PUT', { name, slug, description: desc, environment: env });
        if (res.ok) {
            document.getElementById('editProjectForm').classList.remove('open');
            loadProjects();
        } else {
            errEl.textContent = res.data.message || res.data.detail || 'Failed to update project.';
            errEl.classList.add('visible');
        }
    } catch (err) {
        errEl.textContent = 'Unable to connect.';
        errEl.classList.add('visible');
    }
}

function deleteProject(id, name) {
    showConfirm(
        'Delete Project',
        'Are you sure you want to delete "' + name + '"? All events will be reassigned to the default project.',
        'Delete',
        async () => {
            try {
                await apiCall('/v1/projects/' + id + '?reassign_to=default', 'DELETE');
                loadProjects();
            } catch (err) {}
        }
    );
}


// ═══════════════════════════════════════════════════════════════
//  A P I   K E Y S
// ═══════════════════════════════════════════════════════════════
function setupApiKeys() {
    document.getElementById('toggleCreateKey').addEventListener('click', () => {
        document.getElementById('createKeyForm').classList.toggle('open');
    });
    document.getElementById('cancelKey').addEventListener('click', () => {
        document.getElementById('createKeyForm').classList.remove('open');
    });
    document.getElementById('submitKey').addEventListener('click', createApiKey);
    document.getElementById('copyNewKey').addEventListener('click', function() {
        copyText(document.getElementById('newKeyValue').textContent, this);
    });

    loadApiKeys();
}

async function loadApiKeys() {
    const container = document.getElementById('keyList');
    try {
        const res = await apiCall('/v1/api-keys', 'GET');
        if (!res.ok) { container.innerHTML = '<div class="card-empty">Failed to load API keys.</div>'; return; }

        const keys = res.data.data || [];
        if (keys.length === 0) {
            container.innerHTML = '<div class="card-empty">No API keys. Create one to connect HiveLoop.</div>';
            return;
        }

        container.innerHTML = keys.map(k => `
            <div class="list-row">
                <div class="list-row-info">
                    <div class="list-row-title">${esc(k.label)} <span class="badge ${k.is_active ? 'badge-green' : 'badge-muted'}">${k.is_active ? 'active' : 'revoked'}</span></div>
                    <div class="list-row-meta">
                        ${esc(k.key_prefix)}… · ${esc(k.key_type)} · Created ${fmtDate(k.created_at)}${k.last_used_at ? ' · Last used ' + fmtDate(k.last_used_at) : ''}
                    </div>
                </div>
                <div class="list-row-actions">
                    ${k.is_active ? `<button class="btn-danger-sm" onclick="revokeKey('${k.key_id}', '${esc(k.label)}')">Revoke</button>` : ''}
                </div>
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<div class="card-empty">Failed to load API keys.</div>';
    }
}

async function createApiKey() {
    const labelInput = document.getElementById('keyLabel');
    const label = labelInput.value.trim();
    const errEl = document.getElementById('keyError');
    errEl.classList.remove('visible');

    if (!label) { labelInput.classList.add('input-error'); return; }
    labelInput.classList.remove('input-error');

    const keyType = document.getElementById('keyType').value;

    try {
        const res = await apiCall('/v1/api-keys', 'POST', { label, key_type: keyType });
        if (res.ok) {
            document.getElementById('createKeyForm').classList.remove('open');
            labelInput.value = '';

            // Show the raw key once
            document.getElementById('newKeyValue').textContent = res.data.raw_key;
            document.getElementById('newKeyReveal').classList.add('visible');

            loadApiKeys();
        } else {
            errEl.textContent = res.data.message || res.data.detail || 'Failed to create key.';
            errEl.classList.add('visible');
        }
    } catch (err) {
        errEl.textContent = 'Unable to connect.';
        errEl.classList.add('visible');
    }
}

function revokeKey(keyId, label) {
    showConfirm(
        'Revoke API Key',
        'Are you sure you want to revoke "' + label + '"? This cannot be undone.',
        'Revoke',
        async () => {
            try {
                await apiCall('/v1/api-keys/' + keyId, 'DELETE');
                loadApiKeys();
            } catch (err) {}
        }
    );
}


// ═══════════════════════════════════════════════════════════════
//  T E A M   ( I N V I T E S )
// ═══════════════════════════════════════════════════════════════
function setupTeam() {
    document.getElementById('toggleInvite').addEventListener('click', () => {
        document.getElementById('inviteForm').classList.toggle('open');
    });
    document.getElementById('cancelInvite').addEventListener('click', () => {
        document.getElementById('inviteForm').classList.remove('open');
    });
    document.getElementById('submitInvite').addEventListener('click', sendInvite);
    document.getElementById('copyInviteLink').addEventListener('click', function() {
        copyText(document.getElementById('inviteLinkValue').textContent, this);
    });

    loadInvites();
}

async function loadInvites() {
    const container = document.getElementById('inviteList');
    try {
        const res = await apiCall('/v1/invites', 'GET');
        if (!res.ok) { container.innerHTML = '<div class="card-empty">Failed to load invitations.</div>'; return; }

        const invites = (res.data.data || []).filter(i => !i.is_accepted);
        if (invites.length === 0) {
            container.innerHTML = '<div class="card-empty">No pending invitations.</div>';
            return;
        }

        container.innerHTML = invites.map(inv => `
            <div class="list-row">
                <div class="list-row-info">
                    <div class="list-row-title">${esc(inv.email)} <span class="badge badge-accent">${esc(inv.role)}</span></div>
                    <div class="list-row-meta">
                        Invited ${fmtDate(inv.created_at)} · Expires ${fmtDate(inv.expires_at)}
                    </div>
                </div>
                <div class="list-row-actions">
                    <button class="btn-danger-sm" onclick="cancelInvite('${inv.invite_id}', '${esc(inv.email)}')">Cancel</button>
                </div>
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<div class="card-empty">Failed to load invitations.</div>';
    }
}

async function sendInvite() {
    const emailInput = document.getElementById('inviteEmail');
    const email = emailInput.value.trim();
    const errEl = document.getElementById('inviteError');
    errEl.classList.remove('visible');

    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        emailInput.classList.add('input-error');
        return;
    }
    emailInput.classList.remove('input-error');

    const role = document.getElementById('inviteRole').value;

    try {
        const res = await apiCall('/v1/auth/invite', 'POST', { email, role });

        if (res.ok) {
            document.getElementById('inviteForm').classList.remove('open');
            emailInput.value = '';

            // Build and show the invite link
            const host = window.location.origin;
            const link = host + '/accept-invite.html?token=' + res.data.invite_token;
            document.getElementById('inviteLinkValue').textContent = link;
            document.getElementById('inviteLinkBox').classList.add('visible');

            loadInvites();
        } else if (res.status === 403) {
            errEl.textContent = 'Only workspace owners can invite admins or owners.';
            errEl.classList.add('visible');
        } else if (res.status === 409) {
            const msg = res.data.message || res.data.detail || '';
            if (msg.includes('another organization') || msg.includes('another tenant')) {
                errEl.textContent = 'This email is already registered with another organization. The person must use a different email address to join your workspace.';
            } else if (res.data.error === 'invite_exists') {
                errEl.textContent = 'An invitation has already been sent to this email. Cancel the existing invite first if you need to resend.';
            } else {
                errEl.textContent = 'This person is already a member of your workspace.';
            }
            errEl.classList.add('visible');
        } else {
            errEl.textContent = res.data.message || res.data.detail || 'Failed to send invitation.';
            errEl.classList.add('visible');
        }
    } catch (err) {
        errEl.textContent = 'Unable to connect.';
        errEl.classList.add('visible');
    }
}

function cancelInvite(inviteId, email) {
    showConfirm(
        'Cancel Invitation',
        'Cancel the invitation for ' + email + '?',
        'Cancel Invite',
        async () => {
            try {
                await apiCall('/v1/invites/' + inviteId, 'DELETE');
                loadInvites();
            } catch (err) {}
        }
    );
}

// ═══════════════════════════════════════
// ESCAPE HTML (XSS prevention)
// ═══════════════════════════════════════
function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}
</script>
</body>
</html>
